<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>AcidDocument</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg1:#0d1117;--bg2:#161b22;--bg3:#21262d;--bg4:#30363d;--t1:#f0f6fc;--t2:#c9d1d9;--t3:#8b949e;--t4:#6e7681;--acc:#58a6ff;--accH:#79b8ff;--accM:rgba(88,166,255,.15);--ok:#3fb950;--warn:#d29922;--err:#f85149;--bdr:#30363d;--rad:6px}
[data-theme=light]{--bg1:#fff;--bg2:#f6f8fa;--bg3:#eee;--bg4:#d0d7de;--t1:#1f2328;--t2:#424a53;--t3:#656d76;--t4:#8c959f;--acc:#0969da;--accH:#0550ae;--accM:rgba(9,105,218,.12);--bdr:#d0d7de}
html,body{height:100%;overflow:hidden}
body{font-family:'Pretendard',system-ui,-apple-system,sans-serif;background:var(--bg1);color:var(--t1);font-size:15px;line-height:1.6}
::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:5px}
button{font:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,textarea,select{font:inherit;color:var(--t1);background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--rad);padding:10px 12px;width:100%;outline:none}
input:focus,textarea:focus,select:focus{border-color:var(--acc);box-shadow:0 0 0 3px var(--accM)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border-radius:var(--rad);font-weight:500;transition:all .15s}
.btn:active{transform:scale(.98)}.btn-p{background:var(--acc);color:#fff}.btn-s{background:var(--bg3);border:1px solid var(--bdr)}.btn-g{background:transparent;color:var(--t3)}.btn-g:hover{background:var(--bg3);color:var(--t1)}.btn-d{background:var(--err);color:#fff}.btn-i{width:36px;height:36px;padding:0}.btn-sm{padding:5px 10px;font-size:13px}
.fg{margin-bottom:16px}.fg>label{display:block;font-size:13px;color:var(--t3);margin-bottom:6px}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:500}.badge-p{background:var(--accM);color:var(--acc)}.badge-w{background:rgba(210,153,34,.15);color:var(--warn)}.badge-err{background:rgba(248,81,73,.15);color:var(--err)}
.wrap{display:flex;height:100vh}
.sidebar{width:260px;min-width:260px;height:100%;background:var(--bg2);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden}
.sb-head{padding:16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:12px}
.sb-logo{width:32px;height:32px;background:linear-gradient(135deg,var(--acc),#a855f7);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px}
.sb-title{font-weight:600;font-size:15px;flex:1}
.sb-body{flex:1;overflow-y:auto;padding:8px}
.sb-section{margin-bottom:16px}
.sb-section-title{padding:8px 12px;font-size:11px;font-weight:600;color:var(--t4);text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.sb-section-title .btn-i{width:22px;height:22px;font-size:14px;opacity:0}.sb-section:hover .sb-section-title .btn-i{opacity:1}
.sb-foot{padding:12px;border-top:1px solid var(--bdr)}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--rad);cursor:pointer;color:var(--t2);font-size:14px}
.nav-item:hover{background:var(--bg3);color:var(--t1)}.nav-item.active{background:var(--accM);color:var(--acc)}
.nav-icon{width:20px;text-align:center}.nav-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.nav-badge{font-size:11px;color:var(--t4)}
.tree-item{margin-left:12px}
.tree-row{display:flex;align-items:center;gap:4px;padding:6px 8px;border-radius:var(--rad);cursor:pointer;color:var(--t2);font-size:14px;transition:all .15s}
.tree-row:hover{background:var(--bg3);color:var(--t1)}.tree-row.active{background:var(--accM);color:var(--acc)}
.tree-row.drag-over{outline:2px dashed var(--acc);background:var(--accM)}
.tree-row.dragging{opacity:0.5}
.tree-toggle{width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--t4);transition:transform .15s}
.tree-toggle.open{transform:rotate(90deg)}.tree-toggle.hide{visibility:hidden}
.tree-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tree-fav{color:var(--warn);font-size:11px;opacity:0}.tree-row:hover .tree-fav,.tree-fav.on{opacity:1}
.tree-children.closed{display:none}
.trash-drop{transition:all .2s}.trash-drop.drag-over{background:var(--err);color:#fff;transform:scale(1.05)}
.user-card{display:flex;align-items:center;gap:10px;padding:8px;border-radius:var(--rad);cursor:pointer}.user-card:hover{background:var(--bg3)}
.user-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#fff}
.user-avatar.admin{background:linear-gradient(135deg,var(--ok),#059669)}.user-avatar.super{background:linear-gradient(135deg,var(--warn),#ea580c)}
.user-name{font-size:14px;font-weight:500}.user-role{font-size:12px;color:var(--t4)}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg1)}
.toolbar{height:54px;padding:0 20px;display:flex;align-items:center;gap:12px;background:var(--bg2);border-bottom:1px solid var(--bdr)}
.toolbar-left{flex:1;display:flex;align-items:center;gap:12px;overflow:hidden}.toolbar-right{display:flex;align-items:center;gap:6px}
.breadcrumb{font-size:14px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.mob-menu{display:none}
.notice-bar{background:linear-gradient(90deg,var(--acc),#a855f7);color:#fff;padding:10px 20px;font-size:14px;display:none;align-items:center;gap:10px}
.notice-bar.show{display:flex}
.notice-bar .notice-text{flex:1}.notice-bar .notice-close{cursor:pointer;opacity:0.8}
.editor-wrap{flex:1;overflow-y:auto}
.editor-inner{max-width:850px;margin:0 auto;padding:40px 50px 150px}
.page-head{margin-bottom:32px}
.page-icon{font-size:56px;cursor:pointer;display:inline-block;margin-bottom:12px;user-select:none}.page-icon:hover{transform:scale(1.08)}
.page-title{width:100%;border:none;background:none;font-size:36px;font-weight:700;color:var(--t1);outline:none;padding:0}.page-title::placeholder{color:var(--t4)}
.page-meta{display:flex;flex-wrap:wrap;gap:16px;margin-top:12px;font-size:13px;color:var(--t4)}
.page-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px}
.tag{padding:5px 12px;background:var(--bg3);border-radius:14px;font-size:13px;color:var(--t2);cursor:pointer}.tag:hover{background:var(--bg4)}
.tag-add{border:1px dashed var(--bdr);background:none}.tag-add:hover{border-color:var(--acc);color:var(--acc)}
.editor{min-height:100px}.editor.drag-over{outline:2px dashed var(--acc);background:var(--accM)}
.block{position:relative;padding:3px 0 3px 40px;margin:2px 0;border-radius:var(--rad)}.block:hover{background:var(--bg2)}
.edit-mode .block:hover .block-handle{opacity:1}
.view-mode .block-handle{display:none}
.view-mode .block-content{cursor:text}
.view-mode .block-content:hover{background:var(--bg2);border-radius:var(--rad)}
.view-mode .block{padding-left:0}
.block-handle{position:absolute;left:2px;top:50%;transform:translateY(-50%);display:flex;gap:2px;opacity:0}
.block-handle .btn-i{width:28px;height:28px;font-size:16px;color:var(--t4)}.block-handle .btn-i:hover{background:var(--bg4);color:var(--t1)}
.block-content{outline:none;min-height:24px;line-height:1.7;word-break:break-word;padding:2px 4px;border-radius:var(--rad);transition:background .15s}
.block-content:empty::before{content:'í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';color:var(--t4);pointer-events:none}
.block-toggle-body .block-content:empty::before{content:'í† ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”'}
.block-content:focus{background:var(--bg2)}
.edit-mode .block-content:hover{background:var(--bg2)}
.block-content b,.block-content strong{font-weight:600}.block-content i,.block-content em{font-style:italic}.block-content u{text-decoration:underline}
.block-content code{background:var(--bg3);padding:2px 6px;border-radius:4px;font-family:'Pretendard',monospace;font-size:14px}
.block-h1 .block-content{font-size:30px;font-weight:700;line-height:1.3;margin:28px 0 12px}
.block-h2 .block-content{font-size:24px;font-weight:600;line-height:1.35;margin:24px 0 10px}
.block-h3 .block-content{font-size:20px;font-weight:600;line-height:1.4;margin:20px 0 8px}
.block-quote{border-left:4px solid var(--acc);padding-left:56px;margin:12px 0}.block-quote .block-content{color:var(--t2);font-style:italic}
.block-bullet{padding-left:58px}.block-bullet::before{content:'â€¢';position:absolute;left:42px;top:3px;color:var(--t3);font-size:18px;line-height:1.7}
.block-number{padding-left:58px}.block-number::before{content:attr(data-num)'.';position:absolute;left:40px;top:3px;color:var(--t3);font-size:15px;line-height:1.7}
.block-todo{padding-left:40px}
.block-todo .todo-wrap{display:flex;align-items:flex-start;gap:10px}
.block-todo input[type="checkbox"]{width:18px;height:18px;margin-top:5px;accent-color:var(--acc);cursor:pointer;flex-shrink:0}
.block-todo .block-content{flex:1}
.block-todo.done .block-content{text-decoration:line-through;color:var(--t4)}
.block-toggle{margin:10px 0}
.block-toggle-wrap{padding:4px 0}
.block-toggle-head{display:flex;align-items:flex-start;gap:6px}
.block-toggle-arrow{width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--t4);transition:transform .15s;margin-top:2px;cursor:pointer;border-radius:4px;flex-shrink:0}
.block-toggle-arrow:hover{background:var(--bg3);color:var(--t1)}
.block-toggle-head.open .block-toggle-arrow{transform:rotate(90deg)}
.block-toggle-head .block-content{flex:1;cursor:text}
.block-toggle-body{margin-left:28px;padding-left:14px;border-left:2px solid var(--bdr);margin-top:6px;display:none}
.block-toggle-body.open{display:block}
.block-toggle-body .block-content{min-height:30px}
.block-code{margin:16px 0}
.block-code-wrap{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);overflow:hidden}
.block-code-head{display:flex;justify-content:space-between;align-items:center;padding:8px 14px;background:var(--bg3);border-bottom:1px solid var(--bdr)}
.block-code-lang{font-size:12px;color:var(--t4);font-family:monospace}
.block-code .block-content{padding:14px;font-family:monospace;font-size:14px;white-space:pre-wrap;line-height:1.5}
.block-callout{margin:16px 0}
.block-callout-wrap{display:flex;gap:14px;padding:16px;border-radius:var(--rad)}
.block-callout-wrap.info{background:var(--accM);border-left:4px solid var(--acc)}
.block-callout-wrap.success{background:rgba(63,185,80,.12);border-left:4px solid var(--ok)}
.block-callout-wrap.warning{background:rgba(210,153,34,.12);border-left:4px solid var(--warn)}
.block-callout-wrap.danger{background:rgba(248,81,73,.12);border-left:4px solid var(--err)}
.block-callout-icon{font-size:22px}
.block-divider{padding:20px 40px}.block-divider hr{border:none;height:2px;background:var(--bdr)}
.block-image{margin:20px 0}.block-image img{max-width:100%;border-radius:var(--rad);display:block}
.block-image-caption{margin-top:8px;font-size:14px;color:var(--t4);text-align:center;outline:none}
.block-video{margin:20px 0}.block-video iframe{width:100%;aspect-ratio:16/9;border:none;border-radius:var(--rad)}
.block-pdf{margin:20px 0}.block-pdf iframe{width:100%;height:500px;border:1px solid var(--bdr);border-radius:var(--rad)}
.block-file{margin:16px 0;padding:16px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);display:flex;align-items:center;gap:12px}
.block-file-icon{font-size:28px}.block-file-name{flex:1;font-weight:500;color:var(--acc);text-decoration:none}.block-file-name:hover{text-decoration:underline}
.block-table{margin:20px 0}
.block-table-wrap{border:1px solid var(--bdr);border-radius:var(--rad);overflow:auto;max-height:500px}
.block-table table{width:100%;border-collapse:collapse;table-layout:fixed}
.block-table th,.block-table td{padding:10px 14px;border:1px solid var(--bdr);text-align:left;min-width:60px;outline:none;position:relative;overflow:hidden;word-wrap:break-word}
.block-table th{background:var(--bg3);font-weight:600}
.block-table td{background:var(--bg2)}
.col-resizer{position:absolute;right:0;top:0;width:6px;height:100%;cursor:col-resize;background:transparent;z-index:5}
.col-resizer:hover,.col-resizer.active{background:var(--acc)}
.row-resizer{position:absolute;left:0;bottom:0;width:100%;height:6px;cursor:row-resize;background:transparent;z-index:5}
.row-resizer:hover,.row-resizer.active{background:var(--acc)}
.block-table table{width:100%;border-collapse:collapse;table-layout:fixed}
.block-table th,.block-table td{padding:10px 14px;border:1px solid var(--bdr);text-align:left;min-width:60px;outline:none;position:relative;overflow:hidden;word-wrap:break-word}
.block-table th{background:var(--bg3);font-weight:600;position:sticky;top:0;z-index:1}
.block-table td{background:var(--bg2)}
.col-resizer{position:absolute;right:0;top:0;width:6px;height:100%;cursor:col-resize;background:transparent;z-index:2}
.col-resizer:hover,.col-resizer.active{background:var(--acc)}
.row-resizer{position:absolute;left:0;bottom:0;width:100%;height:6px;cursor:row-resize;background:transparent;z-index:2}
.row-resizer:hover,.row-resizer.active{background:var(--acc)}
.block-table-tools{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;padding:12px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad)}
.block-table-tools .btn{background:var(--bg3);border:1px solid var(--bdr)}
.block-table-tools .btn:hover{background:var(--bg4);border-color:var(--acc)}
.block-table-tools select{padding:6px 10px;font-size:13px;background:var(--bg3);border:1px solid var(--bdr);border-radius:var(--rad);color:var(--t2);cursor:pointer;min-width:80px}
.block-table-tools select:hover{border-color:var(--acc)}
.block-table-tools .tool-group{display:flex;gap:4px;padding-right:12px;border-right:1px solid var(--bdr)}
.block-table-tools .tool-group:last-child{border-right:none;padding-right:0}
.block-toc{margin:20px 0}
.block-toc-wrap{background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);padding:20px}
.block-add-below{text-align:center;padding:8px;margin-top:8px;color:var(--t4);font-size:13px;cursor:pointer;border:1px dashed var(--bdr);border-radius:var(--rad);transition:all .15s}.block-add-below:hover{color:var(--acc);border-color:var(--acc);background:var(--accM)}
.block-toc-title{font-weight:600;margin-bottom:14px}
.block-toc-list{list-style:none}.block-toc-item{padding:6px 0}.block-toc-item a{color:var(--t2);font-size:14px;text-decoration:none}.block-toc-item a:hover{color:var(--acc)}
.block-toc-item.l2{padding-left:20px}.block-toc-item.l3{padding-left:40px}
.block-columns{margin:20px 0}
.block-columns-wrap{display:flex;gap:0;position:relative}
.block-col{flex:1;min-width:80px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);padding:16px;position:relative}
.block-col:not(:last-child){border-right:none;border-radius:var(--rad) 0 0 var(--rad)}
.block-col:not(:first-child){border-radius:0 var(--rad) var(--rad) 0}
.block-col:not(:first-child):not(:last-child){border-radius:0}
.block-col:focus-within{border-color:var(--acc);z-index:1}
.col-divider{width:8px;background:var(--bdr);cursor:col-resize;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background .15s}
.col-divider:hover,.col-divider.active{background:var(--acc)}
.col-divider::after{content:'â‹®';color:var(--t4);font-size:12px}
.col-divider::after{content:'â‹®';color:var(--t4);font-size:12px}
.block-col:focus-within{border-color:var(--acc)}
.block-col-content{outline:none;min-height:60px;line-height:1.6}
.panel{position:fixed;top:0;right:0;width:380px;height:100%;background:var(--bg2);border-left:1px solid var(--bdr);transform:translateX(100%);transition:transform .2s;z-index:100;display:flex;flex-direction:column}
.panel.open{transform:translateX(0)}
.panel-head{height:54px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr)}
.panel-head h3{font-size:16px;font-weight:600}
.panel-body{flex:1;overflow-y:auto;padding:16px}
.panel-foot{padding:14px 16px;border-top:1px solid var(--bdr)}
.ver-item{padding:14px;border-radius:var(--rad);margin-bottom:10px;cursor:pointer;border:1px solid transparent;display:flex;justify-content:space-between;align-items:center}
.ver-item:hover{background:var(--bg3)}.ver-item.current{background:var(--accM);border-color:var(--acc)}
.cmt-item{padding:14px 0;border-bottom:1px solid var(--bdr)}
.cmt-head{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.cmt-avatar{width:30px;height:30px;border-radius:50%;background:var(--acc);display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:200;padding:20px}
.modal-bg.open{display:flex}
.modal{background:var(--bg2);border-radius:12px;width:100%;max-width:500px;max-height:calc(100vh - 40px);display:flex;flex-direction:column;box-shadow:0 20px 50px rgba(0,0,0,.3)}
.modal.lg{max-width:680px}
.modal-head{padding:18px 22px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.modal-head h2{font-size:17px;font-weight:600}
.modal-body{padding:22px;overflow-y:auto;flex:1}
.modal-foot{padding:14px 22px;border-top:1px solid var(--bdr);display:flex;justify-content:flex-end;gap:10px}
.tabs-head{display:flex;border-bottom:1px solid var(--bdr);background:var(--bg3)}
.tab-btn{padding:12px 18px;font-size:14px;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px}
.tab-btn:hover{color:var(--t1)}.tab-btn.on{color:var(--acc);border-color:var(--acc)}
.tab-panel{display:none;padding:22px}.tab-panel.on{display:block}
.search-input-wrap{padding:18px 22px;border-bottom:1px solid var(--bdr)}
.search-input{font-size:17px;padding:12px 16px}
.search-results{max-height:350px;overflow-y:auto;padding:10px}
.search-item{display:flex;align-items:center;gap:14px;padding:12px;border-radius:var(--rad);cursor:pointer}.search-item:hover{background:var(--bg3)}
.slash-menu{position:fixed;background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;width:300px;max-height:380px;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,.25);display:none;z-index:300;padding:6px}
.slash-menu.open{display:block}
.slash-section{padding:8px 12px 6px;font-size:11px;font-weight:600;color:var(--t4);text-transform:uppercase}
.slash-item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--rad);cursor:pointer}
.slash-item:hover,.slash-item.sel{background:var(--acc);color:#fff}
.slash-icon{width:36px;height:36px;background:var(--bg3);border-radius:var(--rad);display:flex;align-items:center;justify-content:center;font-size:16px}
.slash-item:hover .slash-icon,.slash-item.sel .slash-icon{background:rgba(255,255,255,.2)}
.ctx-menu{position:fixed;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,.2);display:none;z-index:400;padding:6px}
.ctx-menu.open{display:block}
.ctx-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:4px;cursor:pointer;font-size:14px;color:var(--t2)}.ctx-item:hover{background:var(--bg3);color:var(--t1)}
.ctx-item.danger{color:var(--err)}.ctx-item.disabled{opacity:0.4;pointer-events:none}.ctx-divider{height:1px;background:var(--bdr);margin:5px 0}
.icon-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px}
.icon-item{padding:10px;border-radius:var(--rad);cursor:pointer;text-align:center;font-size:22px}.icon-item:hover{background:var(--bg4)}
.color-grid{display:flex;flex-wrap:wrap;gap:6px}
.icon-grid{display:flex;flex-wrap:wrap;gap:8px}.icon-item{width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border-radius:var(--rad);transition:background .15s}.icon-item:hover{background:var(--bg3)}
.color-item{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent}.color-item:hover{border-color:var(--t1)}
.toast-wrap{position:fixed;bottom:20px;right:20px;z-index:500;display:flex;flex-direction:column;gap:10px}
.toast{display:flex;align-items:center;gap:10px;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);padding:14px 18px;box-shadow:0 6px 20px rgba(0,0,0,.2);animation:toastIn .25s}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}}
.toast.ok{border-left:4px solid var(--ok)}.toast.err{border-left:4px solid var(--err)}.toast.warn{border-left:4px solid var(--warn)}
.login-screen{position:fixed;inset:0;background:var(--bg1);display:flex;align-items:center;justify-content:center;z-index:1000}
.login-screen.hidden{display:none}
.login-box{width:100%;max-width:380px;padding:40px}
.login-logo{text-align:center;margin-bottom:36px}
.login-logo h1{font-size:28px;font-weight:700}.login-logo span{color:var(--acc)}
.login-error{background:rgba(248,81,73,.1);border:1px solid var(--err);color:var(--err);padding:12px;border-radius:var(--rad);margin-bottom:18px;font-size:14px;display:none}
.login-locked{background:rgba(210,153,34,.1);border:1px solid var(--warn);color:var(--warn);padding:16px;border-radius:var(--rad);margin-bottom:18px;font-size:14px;display:none;text-align:center}
.login-blocked{background:rgba(248,81,73,.15);border:1px solid var(--err);color:var(--err);padding:20px;border-radius:var(--rad);font-size:14px;text-align:center;display:none}
.login-form .btn{width:100%;padding:12px;margin-top:6px}
.theme-float{position:absolute;top:20px;right:20px}
.dtable{width:100%;border-collapse:collapse}.dtable th,.dtable td{padding:12px;text-align:left;border-bottom:1px solid var(--bdr)}.dtable th{font-size:12px;font-weight:600;color:var(--t4);text-transform:uppercase}
.mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:90}.mob-overlay.open{display:block}
.fmt-bar{position:fixed;background:var(--bg2);border:1px solid var(--bdr);border-radius:var(--rad);padding:4px;display:none;z-index:350;box-shadow:0 4px 20px rgba(0,0,0,.2)}
.fmt-bar.open{display:flex;gap:2px}
.fmt-bar .btn-i{width:32px;height:32px;font-size:14px}
@media(max-width:768px){
.sidebar{position:fixed;left:0;top:0;z-index:100;transform:translateX(-100%);transition:transform .25s}.sidebar.open{transform:translateX(0)}
.mob-menu{display:flex!important}
.editor-inner{padding:24px 18px 120px}
.page-icon{font-size:44px}.page-title{font-size:28px}
.panel{width:100%}.modal{max-width:calc(100% - 20px)}
.block-columns-wrap{flex-direction:column}
}
</style>
</head>
<body>
<div class="login-screen" id="loginScreen">
<button class="btn btn-i btn-g theme-float" onclick="toggleTheme()">ğŸŒ“</button>
<div class="login-box">
<div class="login-logo"><h1>Acid<span>Document</span></h1></div>
<div class="login-blocked" id="loginBlocked">ğŸš« ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>
<div class="login-locked" id="loginLocked">ğŸ”’ ë¡œê·¸ì¸ ì‹œë„ ì´ˆê³¼<br><span id="lockTimer">5:00</span> í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</div>
<div class="login-error" id="loginError"></div>
<form id="loginForm">
<div class="fg"><label>ì•„ì´ë””</label><input type="text" id="loginId" required></div>
<div class="fg"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="loginPw" required></div>
<button type="submit" class="btn btn-p">ë¡œê·¸ì¸</button>
</form>
</div>
</div>
<div class="modal-bg" id="pwChangeModal">
<div class="modal" style="max-width:420px">
<div class="modal-head"><h2>ğŸ” ì´ˆê¸° ì„¤ì •</h2></div>
<div class="modal-body">
<p style="color:var(--t3);margin-bottom:18px;font-size:14px">ë‹‰ë„¤ì„ê³¼ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
<div class="fg"><label>ë‹‰ë„¤ì„ (í‘œì‹œ ì´ë¦„)</label><input type="text" id="pwNickname" placeholder="í™ê¸¸ë™"></div>
<div class="fg"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="pwCur"></div>
<div class="fg"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="pwNew"></div>
<div class="fg"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" id="pwConfirm"></div>
</div>
<div class="modal-foot">
<button class="btn btn-s" onclick="skipPwChange()">ë‚˜ì¤‘ì—</button>
<button class="btn btn-p" onclick="submitPwChange()">ì €ì¥</button>
</div>
</div>
</div>
<div class="wrap" id="appWrap" style="display:none">
<div class="mob-overlay" id="mobOverlay" onclick="closeMobile()"></div>
<aside class="sidebar" id="sidebar">
<div class="sb-head"><div class="sb-logo">A</div><span class="sb-title" id="wsName">AcidDocument</span></div>
<div class="sb-body">
<div class="sb-section"><div class="nav-item" onclick="openSearch()"><span class="nav-icon">ğŸ”</span><span class="nav-text">ê²€ìƒ‰</span><span class="nav-badge">âŒ˜K</span></div></div>
<div class="sb-section">
<div class="sb-section-title">ë°”ë¡œê°€ê¸°</div>
<div class="nav-item" onclick="showNotice()"><span class="nav-icon">ğŸ“¢</span><span class="nav-text">ê³µì§€ì‚¬í•­</span></div>
<div class="nav-item" onclick="showRecent()"><span class="nav-icon">ğŸ•</span><span class="nav-text">ìµœê·¼ ë¬¸ì„œ</span></div>
<div class="nav-item" onclick="showFavorites()"><span class="nav-icon">â­</span><span class="nav-text">ì¦ê²¨ì°¾ê¸°</span></div>
<div class="nav-item" onclick="showTemplates()"><span class="nav-icon">ğŸ“‹</span><span class="nav-text">í…œí”Œë¦¿</span></div>
<div class="nav-item trash-drop" id="trashDrop" onclick="showTrash()"><span class="nav-icon">ğŸ—‘ï¸</span><span class="nav-text">íœ´ì§€í†µ</span></div>
</div>
<div class="sb-section">
<div class="sb-section-title">í˜ì´ì§€<button class="btn btn-i btn-g" onclick="createPage()">+</button></div>
<div id="pageTree"></div>
</div>
</div>
<div class="sb-foot">
<div class="user-card" onclick="openSettings()">
<div class="user-avatar admin" id="userAvatar">AD</div>
<div><div class="user-name" id="userName">admin</div><div class="user-role" id="userRole">ê´€ë¦¬ì</div></div>
</div>
</div>
</aside>
<main class="main">
<div class="notice-bar" id="noticeBar"><span class="notice-text" id="noticeText"></span><span class="notice-close" onclick="closeNoticeBar()">âœ•</span></div>
<div class="toolbar">
<div class="toolbar-left"><button class="btn btn-i btn-g mob-menu" onclick="toggleMobile()">â˜°</button><div class="breadcrumb" id="breadcrumb"></div></div>
<div class="toolbar-right">
<button class="btn btn-i btn-g" onclick="toggleTheme()">ğŸŒ“</button>
<button class="btn btn-i btn-g" onclick="openComments()">ğŸ’¬</button>
<button class="btn btn-i btn-g" onclick="openVersions()">ğŸ“œ</button>
<button class="btn btn-i btn-g" onclick="openExport()">ğŸ“¤</button>
<button class="btn btn-sm btn-s" id="editBtn" onclick="toggleEdit()" style="display:inline-flex">âœï¸ ìˆ˜ì •</button>
<button class="btn btn-sm btn-s" id="deletePageBtn" onclick="deleteCurrentPage()" style="color:var(--err)">ğŸ—‘ï¸ ì‚­ì œ</button>
<button class="btn btn-p btn-sm" id="saveBtn" onclick="saveAndExit()" style="display:none">ğŸ’¾ ì €ì¥</button>
<button class="btn btn-s btn-sm" id="cancelBtn" onclick="cancelEdit()" style="display:none">ì·¨ì†Œ</button>
</div>
</div>
<div class="editor-wrap" id="editorWrap">
<div class="editor-inner">
<div class="page-head">
<div class="page-icon" id="pageIcon" onclick="openIconPicker()">ğŸ“„</div>
<input type="text" class="page-title" id="pageTitle" placeholder="ì œëª© ì—†ìŒ" oninput="onTitleChange()">
<div class="page-meta" id="pageMeta"></div>
<div class="page-tags" id="pageTags"></div>
</div>
<div class="editor" id="editor"></div>
</div>
</div>
</main>
<div class="panel" id="versionPanel">
<div class="panel-head"><h3>ğŸ“œ ë²„ì „ ê¸°ë¡</h3><button class="btn btn-i btn-g" onclick="closePanel('versionPanel')">âœ•</button></div>
<div class="panel-body" id="versionList"></div>
</div>
<div class="panel" id="commentPanel">
<div class="panel-head"><h3>ğŸ’¬ ëŒ“ê¸€</h3><button class="btn btn-i btn-g" onclick="closePanel('commentPanel')">âœ•</button></div>
<div class="panel-body" id="commentList"></div>
<div class="panel-foot"><textarea id="commentInput" rows="3" placeholder="ëŒ“ê¸€..."></textarea><button class="btn btn-p" style="width:100%;margin-top:10px" onclick="addComment()">ì‘ì„±</button></div>
</div>
</div>
<div class="modal-bg" id="searchModal" onclick="if(event.target===this)closeModal('searchModal')"><div class="modal" style="max-width:560px"><div class="search-input-wrap"><input type="text" class="search-input" id="searchInput" placeholder="ê²€ìƒ‰..." oninput="doSearch(this.value)"></div><div class="search-results" id="searchResults"></div></div></div>
<div class="modal-bg" id="settingsModal" onclick="if(event.target===this)closeModal('settingsModal')">
<div class="modal lg">
<div class="modal-head"><h2>âš™ï¸ ì„¤ì •</h2><button class="btn btn-i btn-g" onclick="closeModal('settingsModal')">âœ•</button></div>
<div class="tabs-head"><div class="tab-btn on" onclick="showSettingsTab('profile',this)">í”„ë¡œí•„</div><div class="tab-btn" onclick="showSettingsTab('users',this)">ì‚¬ìš©ì</div><div class="tab-btn" onclick="showSettingsTab('notice',this)">ê³µì§€</div><div class="tab-btn" onclick="showSettingsTab('workspace',this)">ì›Œí¬ìŠ¤í˜ì´ìŠ¤</div></div>
<div class="tab-panel on" id="tabProfile">
<div class="fg"><label>ì•„ì´ë””</label><input id="setUserId" readonly></div>
<div class="fg"><label>ë‹‰ë„¤ì„</label><input id="setNickname"></div>
<button class="btn btn-s" onclick="saveNickname()" style="margin-bottom:20px">ë‹‰ë„¤ì„ ì €ì¥</button>
<div class="fg"><label>ì—­í• </label><input id="setUserRole" readonly></div>
<hr style="border:none;border-top:1px solid var(--bdr);margin:20px 0">
<div class="fg"><label>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="setPwCur"></div>
<div class="fg"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="setPwNew"></div>
<button class="btn btn-p" onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
<hr style="border:none;border-top:1px solid var(--bdr);margin:20px 0">
<button class="btn btn-s" style="color:var(--err)" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
</div>
<div class="tab-panel" id="tabUsers">
<table class="dtable" id="usersTable"></table>
<hr style="border:none;border-top:1px solid var(--bdr);margin:20px 0">
<div style="display:flex;gap:12px"><div class="fg" style="flex:1"><label>ì•„ì´ë””</label><input id="newUserId" readonly></div><div class="fg" style="flex:1"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="newUserPw" readonly></div></div>
<button class="btn btn-p" onclick="createUser()">ì‚¬ìš©ì ìƒì„±</button>
</div>
<div class="tab-panel" id="tabNotice">
<div class="fg"><label>ê³µì§€ì‚¬í•­ ë‚´ìš©</label><textarea id="noticeContent" rows="4" placeholder="ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea></div>
<div style="display:flex;gap:10px">
<button class="btn btn-p" onclick="saveNotice()">ê³µì§€ ì €ì¥</button>
<button class="btn btn-d" onclick="clearNotice()">ê³µì§€ ì‚­ì œ</button>
</div>
</div>
<div class="tab-panel" id="tabWorkspace"><div class="fg"><label>ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„</label><input id="setWsName"></div><button class="btn btn-p" onclick="saveWorkspace()">ì €ì¥</button></div>
</div>
</div>
<div class="modal-bg" id="noticeModal" onclick="if(event.target===this)closeModal('noticeModal')"><div class="modal"><div class="modal-head"><h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2><button class="btn btn-i btn-g" onclick="closeModal('noticeModal')">âœ•</button></div><div class="modal-body" id="noticeBody" style="white-space:pre-wrap"></div></div></div>
<div class="modal-bg" id="exportModal" onclick="if(event.target===this)closeModal('exportModal')"><div class="modal" style="max-width:360px"><div class="modal-head"><h2>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</h2><button class="btn btn-i btn-g" onclick="closeModal('exportModal')">âœ•</button></div><div class="modal-body"><div class="nav-item" onclick="exportDoc('md')"><span class="nav-icon">ğŸ“</span><span class="nav-text">Markdown</span></div><div class="nav-item" onclick="exportDoc('html')"><span class="nav-icon">ğŸŒ</span><span class="nav-text">HTML</span></div><div class="nav-item" onclick="exportDoc('txt')"><span class="nav-icon">ğŸ“„</span><span class="nav-text">í…ìŠ¤íŠ¸</span></div><div class="nav-item" onclick="exportDoc('pdf')"><span class="nav-icon">ğŸ“‘</span><span class="nav-text">PDF</span></div></div></div></div>
<div class="modal-bg" id="iconModal" onclick="if(event.target===this)closeModal('iconModal')"><div class="modal"><div class="modal-head"><h2>ğŸ¨ ì•„ì´ì½˜</h2><button class="btn btn-i btn-g" onclick="closeModal('iconModal')">âœ•</button></div><div class="modal-body"><div class="icon-grid" id="iconGrid"></div></div></div></div>
<div class="modal-bg" id="trashModal" onclick="if(event.target===this)closeModal('trashModal')"><div class="modal lg"><div class="modal-head"><h2>ğŸ—‘ï¸ íœ´ì§€í†µ</h2><button class="btn btn-i btn-g" onclick="closeModal('trashModal')">âœ•</button></div><div class="modal-body" id="trashList"></div><div class="modal-foot" id="trashFoot" style="display:none"><button class="btn btn-d" onclick="emptyTrash()">íœ´ì§€í†µ ë¹„ìš°ê¸°</button></div></div></div>
<div class="modal-bg" id="recentModal" onclick="if(event.target===this)closeModal('recentModal')"><div class="modal"><div class="modal-head"><h2>ğŸ• ìµœê·¼</h2><button class="btn btn-i btn-g" onclick="closeModal('recentModal')">âœ•</button></div><div class="modal-body" id="recentList"></div></div></div>
<div class="modal-bg" id="favoritesModal" onclick="if(event.target===this)closeModal('favoritesModal')"><div class="modal"><div class="modal-head"><h2>â­ ì¦ê²¨ì°¾ê¸°</h2><button class="btn btn-i btn-g" onclick="closeModal('favoritesModal')">âœ•</button></div><div class="modal-body" id="favoritesList"></div></div></div>
<div class="modal-bg" id="templatesModal" onclick="if(event.target===this)closeModal('templatesModal')"><div class="modal"><div class="modal-head"><h2>ğŸ“‹ í…œí”Œë¦¿</h2><button class="btn btn-i btn-g" onclick="closeModal('templatesModal')">âœ•</button></div><div class="modal-body" id="templatesList"></div></div></div>
<div class="modal-bg" id="imageModal" onclick="if(event.target===this)closeModal('imageModal')"><div class="modal" style="max-width:420px"><div class="modal-head"><h2>ğŸ–¼ï¸ ì´ë¯¸ì§€</h2><button class="btn btn-i btn-g" onclick="closeModal('imageModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>ì´ë¯¸ì§€ URL</label><input id="imageUrl" placeholder="https://..."></div><button class="btn btn-p" onclick="insertImage()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="videoModal" onclick="if(event.target===this)closeModal('videoModal')"><div class="modal" style="max-width:420px"><div class="modal-head"><h2>ğŸ¬ ë™ì˜ìƒ</h2><button class="btn btn-i btn-g" onclick="closeModal('videoModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>YouTube URL</label><input id="videoUrl" placeholder="https://youtube.com/..."></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('videoModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="insertVideo()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="pdfModal" onclick="if(event.target===this)closeModal('pdfModal')"><div class="modal" style="max-width:420px"><div class="modal-head"><h2>ğŸ“„ PDF</h2><button class="btn btn-i btn-g" onclick="closeModal('pdfModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>PDF URL</label><input id="pdfUrl" placeholder="https://..."></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('pdfModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="insertPdf()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="fileModal" onclick="if(event.target===this)closeModal('fileModal')"><div class="modal" style="max-width:420px"><div class="modal-head"><h2>ğŸ“ íŒŒì¼</h2><button class="btn btn-i btn-g" onclick="closeModal('fileModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>íŒŒì¼ URL</label><input id="fileUrl" placeholder="https://github.com/..."></div><div class="fg"><label>íŒŒì¼ëª…</label><input id="fileName" placeholder="íŒŒì¼ëª….í™•ì¥ì"></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('fileModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="insertFile()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="colorModal" onclick="if(event.target===this)closeModal('colorModal')"><div class="modal" style="max-width:320px"><div class="modal-head"><h2>ğŸ¨ í…ìŠ¤íŠ¸ ìƒ‰ìƒ</h2><button class="btn btn-i btn-g" onclick="closeModal('colorModal')">âœ•</button></div><div class="modal-body"><div class="color-grid" id="colorGrid"></div></div></div></div>
<div class="modal-bg" id="tagModal" onclick="if(event.target===this)closeModal('tagModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>ğŸ·ï¸ íƒœê·¸ ì¶”ê°€</h2><button class="btn btn-i btn-g" onclick="closeModal('tagModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>íƒœê·¸ ì´ë¦„</label><input type="text" id="tagInput" placeholder="ì˜ˆ: ì¤‘ìš”, ì§„í–‰ì¤‘, ì™„ë£Œ"></div><div style="margin-top:12px"><p style="font-size:13px;color:var(--t4);margin-bottom:8px">ì¶”ì²œ íƒœê·¸</p><div style="display:flex;flex-wrap:wrap;gap:6px"><span class="tag" style="cursor:pointer" onclick="quickTag('ì¤‘ìš”')">ğŸ”´ ì¤‘ìš”</span><span class="tag" style="cursor:pointer" onclick="quickTag('ì§„í–‰ì¤‘')">ğŸŸ¡ ì§„í–‰ì¤‘</span><span class="tag" style="cursor:pointer" onclick="quickTag('ì™„ë£Œ')">ğŸŸ¢ ì™„ë£Œ</span><span class="tag" style="cursor:pointer" onclick="quickTag('ê²€í† í•„ìš”')">ğŸ”µ ê²€í† í•„ìš”</span></div></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('tagModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitTag()">ì¶”ê°€</button></div></div></div>
<div class="modal-bg" id="editCommentModal" onclick="if(event.target===this)closeModal('editCommentModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>âœï¸ ëŒ“ê¸€ ìˆ˜ì •</h2><button class="btn btn-i btn-g" onclick="closeModal('editCommentModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>ëŒ“ê¸€ ë‚´ìš©</label><textarea id="editCommentInput" rows="4"></textarea></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('editCommentModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitEditComment()">ì €ì¥</button></div></div></div>
<div class="modal-bg" id="imageUploadModal" onclick="if(event.target===this)closeModal('imageUploadModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì‚½ì…</h2><button class="btn btn-i btn-g" onclick="closeModal('imageUploadModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>URLë¡œ ì‚½ì…</label><input type="text" id="imageUrlInput" placeholder="https://..."></div><div style="text-align:center;margin:16px 0;color:var(--t4)">ë˜ëŠ”</div><div class="fg"><label>íŒŒì¼ ì—…ë¡œë“œ</label><input type="file" id="imageFileInput" accept="image/*"></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('imageUploadModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitImage()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="videoUploadModal" onclick="if(event.target===this)closeModal('videoUploadModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>ğŸ¬ ë™ì˜ìƒ ì‚½ì…</h2><button class="btn btn-i btn-g" onclick="closeModal('videoUploadModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>YouTube URL</label><input type="text" id="videoUrlInput" placeholder="https://youtube.com/..."></div><div style="text-align:center;margin:16px 0;color:var(--t4)">ë˜ëŠ”</div><div class="fg"><label>íŒŒì¼ ì—…ë¡œë“œ</label><input type="file" id="videoFileInput" accept="video/*"></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('videoUploadModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitVideo()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="pdfUploadModal" onclick="if(event.target===this)closeModal('pdfUploadModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>ğŸ“‘ PDF ì‚½ì…</h2><button class="btn btn-i btn-g" onclick="closeModal('pdfUploadModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>URLë¡œ ì‚½ì…</label><input type="text" id="pdfUrlInput" placeholder="https://...pdf"></div><div style="text-align:center;margin:16px 0;color:var(--t4)">ë˜ëŠ”</div><div class="fg"><label>íŒŒì¼ ì—…ë¡œë“œ</label><input type="file" id="pdfFileInput" accept=".pdf"></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('pdfUploadModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitPdf()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="fileUploadModal" onclick="if(event.target===this)closeModal('fileUploadModal')"><div class="modal" style="max-width:400px"><div class="modal-head"><h2>ğŸ“ íŒŒì¼ ì‚½ì…</h2><button class="btn btn-i btn-g" onclick="closeModal('fileUploadModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>íŒŒì¼ ì—…ë¡œë“œ</label><input type="file" id="fileFileInput"></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('fileUploadModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitFile()">ì‚½ì…</button></div></div></div>
<div class="modal-bg" id="calloutIconModal" onclick="if(event.target===this)closeModal('calloutIconModal')"><div class="modal" style="max-width:360px"><div class="modal-head"><h2>ğŸ’¡ ì½œì•„ì›ƒ ì•„ì´ì½˜</h2><button class="btn btn-i btn-g" onclick="closeModal('calloutIconModal')">âœ•</button></div><div class="modal-body"><div class="icon-grid" id="calloutIconGrid"></div></div></div></div>
<div class="modal-bg" id="codeSettingModal" onclick="if(event.target===this)closeModal('codeSettingModal')"><div class="modal" style="max-width:360px"><div class="modal-head"><h2>ğŸ’» ì½”ë“œ ì„¤ì •</h2><button class="btn btn-i btn-g" onclick="closeModal('codeSettingModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>ì–¸ì–´/ì œëª©</label><input type="text" id="codeLangInput" placeholder="javascript, python, etc."></div></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('codeSettingModal')">ì·¨ì†Œ</button><button class="btn btn-p" onclick="submitCodeLang()">ì €ì¥</button></div></div></div>
<div class="modal-bg" id="tableAlignModal" onclick="if(event.target===this)closeModal('tableAlignModal')"><div class="modal" style="max-width:320px"><div class="modal-head"><h2>ğŸ“Š í‘œ ì„¤ì •</h2><button class="btn btn-i btn-g" onclick="closeModal('tableAlignModal')">âœ•</button></div><div class="modal-body"><div class="fg"><label>í…ìŠ¤íŠ¸ ì •ë ¬</label><div style="display:flex;gap:8px"><button class="btn btn-s" onclick="setTblAlign('left')">ì™¼ìª½</button><button class="btn btn-s" onclick="setTblAlign('center')">ê°€ìš´ë°</button><button class="btn btn-s" onclick="setTblAlign('right')">ì˜¤ë¥¸ìª½</button></div></div><div class="fg" style="margin-top:16px"><button class="btn btn-s" style="width:100%;color:var(--err)" onclick="deleteTable()">ğŸ—‘ï¸ í‘œ ì‚­ì œ</button></div></div></div></div>
<div class="modal-bg" id="deleteConfirmModal"><div class="modal" style="max-width:360px"><div class="modal-head"><h2>ğŸ—‘ï¸ ì‚­ì œ í™•ì¸</h2></div><div class="modal-body"><p id="deleteConfirmText">ì´ í˜ì´ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p></div><div class="modal-foot"><button class="btn btn-s" onclick="closeModal('deleteConfirmModal')">ì·¨ì†Œ</button><button class="btn btn-d" onclick="confirmDelete()">ì‚­ì œ</button></div></div></div>
<div class="ctx-menu" id="ctxMenu"></div>
<div class="slash-menu" id="slashMenu"></div>
<div class="fmt-bar" id="fmtBar">
<button class="btn btn-i btn-g" onclick="fmtCmd('bold')" title="êµµê²Œ"><b>B</b></button>
<button class="btn btn-i btn-g" onclick="fmtCmd('italic')" title="ê¸°ìš¸ì„"><i>I</i></button>
<button class="btn btn-i btn-g" onclick="fmtCmd('underline')" title="ë°‘ì¤„"><u>U</u></button>
<button class="btn btn-i btn-g" onclick="fmtCmd('justifyLeft')" title="ì™¼ìª½">â«·</button>
<button class="btn btn-i btn-g" onclick="fmtCmd('justifyCenter')" title="ê°€ìš´ë°">â˜°</button>
<button class="btn btn-i btn-g" onclick="fmtCmd('justifyRight')" title="ì˜¤ë¥¸ìª½">â«¸</button>
<button class="btn btn-i btn-g" onclick="openColorPicker()" title="ìƒ‰ìƒ">ğŸ¨</button>
</div>
<div class="toast-wrap" id="toastWrap"></div>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
// Firebase ë¡œë“œ ëŒ€ê¸°
(function waitForFirebase(){
  if(typeof firebase==='undefined'){setTimeout(waitForFirebase,50);return}
  startApp();
})();

function startApp(){
// Firebase ì´ˆê¸°í™”
var firebaseConfig={apiKey:"AIzaSyBqHTIoLGKnCnR8n8jFGS3a4LGhIJe5xQI",authDomain:"aciddocument.firebaseapp.com",projectId:"aciddocument",storageBucket:"aciddocument.firebasestorage.app",messagingSenderId:"834603817632",appId:"1:834603817632:web:5bd935f6805e05582307c5"};
firebase.initializeApp(firebaseConfig);
var firestore=firebase.firestore();

var SUPER='admin8184',MAX_VER=10;
var ICONS=['ğŸ“„','ğŸ“','ğŸ“‹','ğŸ“','ğŸ“š','ğŸ“–','ğŸ“Œ','ğŸ’¡','â­','ğŸ”¥','âœ¨','ğŸš€','ğŸ¨','ğŸ’»','ğŸ“Š','ğŸ¯','ğŸ‘‹','â¤ï¸','ğŸ ','ğŸ“±','ğŸ”§','âš™ï¸','ğŸ','ğŸ’','ğŸŒŸ','ğŸ“ˆ','ğŸ”’','ğŸ’¬','ğŸ“®','ğŸ—‚ï¸','ğŸ“‘','ğŸ”–','ğŸµ','ğŸ¬','ğŸ“·','ğŸŒ','âš¡','ğŸ””','âœ…','âŒ','âš ï¸','ğŸ’°','ğŸ“','ğŸ†','ğŸŒˆ','â˜€ï¸','ğŸŒ™'];
var COLORS=['#f85149','#ff7b72','#ffa657','#d29922','#3fb950','#56d364','#58a6ff','#79b8ff','#a371f7','#bc8cff','#f0f6fc','#8b949e','#6e7681','#30363d'];
var SLASH=[
  {s:'ê¸°ë³¸',i:[{t:'text',c:'T',n:'í…ìŠ¤íŠ¸',d:'ì¼ë°˜ í…ìŠ¤íŠ¸'},{t:'h1',c:'H1',n:'ì œëª© 1',d:'í° ì œëª©'},{t:'h2',c:'H2',n:'ì œëª© 2',d:'ì¤‘ê°„ ì œëª©'},{t:'h3',c:'H3',n:'ì œëª© 3',d:'ì‘ì€ ì œëª©'}]},
  {s:'ë¦¬ìŠ¤íŠ¸',i:[{t:'bullet',c:'â€¢',n:'ê¸€ë¨¸ë¦¬ ê¸°í˜¸',d:'ëª©ë¡'},{t:'number',c:'1.',n:'ë²ˆí˜¸ ëª©ë¡',d:'ìˆœì„œ'},{t:'todo',c:'â˜‘',n:'í•  ì¼',d:'ì²´í¬ë¦¬ìŠ¤íŠ¸'},{t:'toggle',c:'â–¶',n:'í† ê¸€',d:'ì ‘ê¸°/í¼ì¹˜ê¸°'}]},
  {s:'ë¯¸ë””ì–´',i:[{t:'image',c:'ğŸ–¼',n:'ì´ë¯¸ì§€',d:'URL'},{t:'video',c:'ğŸ¬',n:'ë™ì˜ìƒ',d:'YouTube'},{t:'pdf',c:'ğŸ“„',n:'PDF',d:'PDF ë·°ì–´'},{t:'file',c:'ğŸ“',n:'íŒŒì¼',d:'íŒŒì¼ ë§í¬'}]},
  {s:'í…Œì´ë¸”/ì½”ë“œ',i:[{t:'table',c:'â–¦',n:'í‘œ',d:'í…Œì´ë¸”'},{t:'code',c:'</>',n:'ì½”ë“œ',d:'ì½”ë“œ ë¸”ë¡'}]},
  {s:'ë ˆì´ì•„ì›ƒ',i:[{t:'col2',c:'â–â–Œ',n:'2ì—´',d:'2ì»¬ëŸ¼'},{t:'col3',c:'â–â–â–Œ',n:'3ì—´',d:'3ì»¬ëŸ¼'}]},
  {s:'ê¸°íƒ€',i:[{t:'quote',c:'"',n:'ì¸ìš©',d:'ì¸ìš©ë¬¸'},{t:'callout',c:'ğŸ’¡',n:'ì½œì•„ì›ƒ',d:'ê°•ì¡°'},{t:'divider',c:'â€”',n:'êµ¬ë¶„ì„ ',d:'êµ¬ë¶„'},{t:'toc',c:'ğŸ“‘',n:'ëª©ì°¨',d:'ìë™ ëª©ì°¨'}]}
];
var db,user,page,slashSt={open:false,idx:null},autoT=null,isComp=false,dragPageId=null,deleteTargetId=null,editMode=false,editBackup=null;
function $(id){return document.getElementById(id)}
function $$(s){return document.querySelectorAll(s)}
function genId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,8)}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function fmtD(t){return new Date(t).toLocaleDateString('ko-KR',{year:'numeric',month:'short',day:'numeric'})}
function fmtDT(t){return new Date(t).toLocaleString('ko-KR')}
function getLoginState(){var s=localStorage.getItem('ad_login_state');if(s){try{return JSON.parse(s)}catch(e){}}return{attempts:0,lockUntil:0,blocked:false}}
function saveLoginState(st){localStorage.setItem('ad_login_state',JSON.stringify(st))}

function initDB(){
  return firestore.collection('app').doc('data').get().then(function(doc){
    if(doc.exists){db=convertRowsForLoad(doc.data())}
    else{
      db={
        users:[
          {id:'admin8184',pw:'Kx7mR2pL9nQw',role:'super',needPw:true,active:true,nickname:''},
          {id:'admin3926',pw:'Ht5vB8cN1jYf',role:'admin',needPw:true,active:true,nickname:''}
        ],
        pages:[{
          id:'welcome',title:'ì‹œì‘í•˜ê¸°',icon:'ğŸ‘‹',parentId:null,
          blocks:[
            {id:genId(),type:'h1',content:'AcidDocumentì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!'},
            {id:genId(),type:'text',content:'íŒ€ì„ ìœ„í•œ ë¬¸ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.'},
            {id:genId(),type:'callout',content:'<b>ğŸ’¡ ì‚¬ìš©ë²•:</b> ë¹ˆ ì¤„ì—ì„œ <code>/</code>ë¥¼ ì…ë ¥í•˜ì—¬ ë‹¤ì–‘í•œ ë¸”ë¡ì„ ì¶”ê°€í•˜ì„¸ìš”.',calloutType:'info'}
          ],
          tags:['ê°€ì´ë“œ'],author:'admin8184',created:Date.now(),updated:Date.now(),versions:[],comments:[],favorite:true,deleted:false
        }],
        templates:[
          {id:'meeting',name:'íšŒì˜ë¡',icon:'ğŸ“‹',blocks:[
            {id:genId(),type:'h1',content:'ğŸ“‹ íšŒì˜ë¡'},
            {id:genId(),type:'table',rowsJson:'[["í•­ëª©","ë‚´ìš©"],["ğŸ“… íšŒì˜ ì¼ì‹œ",""],["ğŸ“ íšŒì˜ ì¥ì†Œ",""],["ğŸ‘¥ ì°¸ì—¬ ëŒ€ìƒ",""],["ğŸ“Œ íšŒì˜ ì£¼ì œ",""],["ğŸ¤ ë°œì–¸ì",""]]'},
            {id:genId(),type:'h2',content:'ğŸ“ íšŒì˜ ë‚´ìš©'},{id:genId(),type:'text',content:''},
            {id:genId(),type:'h2',content:'âœ… íšŒì˜ ê²°ë¡ '},{id:genId(),type:'bullet',content:''},
            {id:genId(),type:'h2',content:'ğŸ“Œ Action Items'},{id:genId(),type:'todo',content:'',checked:false},
            {id:genId(),type:'h2',content:'ğŸ“ ë¹„ê³ '},{id:genId(),type:'text',content:''}
          ]},
          {id:'note',name:'ë…¸íŠ¸',icon:'ğŸ“',blocks:[{id:genId(),type:'h1',content:''},{id:genId(),type:'text',content:''}]},
          {id:'project',name:'í”„ë¡œì íŠ¸',icon:'ğŸš€',blocks:[
            {id:genId(),type:'h1',content:'í”„ë¡œì íŠ¸ëª…'},
            {id:genId(),type:'callout',content:'í”„ë¡œì íŠ¸ ê°œìš”',calloutType:'info'},
            {id:genId(),type:'h2',content:'ëª©í‘œ'},{id:genId(),type:'bullet',content:''},
            {id:genId(),type:'h2',content:'ì¼ì •'},
            {id:genId(),type:'table',rowsJson:'[["ë‹¨ê³„","ì‹œì‘ì¼","ì¢…ë£Œì¼","ë‹´ë‹¹ì"],["ê¸°íš","","",""],["ê°œë°œ","","",""],["í…ŒìŠ¤íŠ¸","","",""]]'}
          ]}
        ],
        settings:{wsName:'AcidDocument',theme:'dark',notice:''},
        session:null,recent:[]
      };
      return saveDB();
    }
  }).catch(function(e){console.error('DB ë¡œë“œ ì‹¤íŒ¨:',e);toast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨','err')});
}
// rows/columns ë°°ì—´ì„ JSON ë¬¸ìì—´ë¡œ ë³€í™˜ (ì €ì¥ìš©)
function convertRowsForSave(obj){
  if(!obj)return obj;
  if(Array.isArray(obj)){
    return obj.map(function(item){return convertRowsForSave(item)});
  }
  if(typeof obj==='object'){
    var newObj={};
    for(var key in obj){
      if(key==='rows'&&Array.isArray(obj[key])){
        newObj.rowsJson=JSON.stringify(obj[key]);
      }else if(key==='columns'&&Array.isArray(obj[key])){
        newObj.columnsJson=JSON.stringify(obj[key]);
      }else{
        newObj[key]=convertRowsForSave(obj[key]);
      }
    }
    return newObj;
  }
  return obj;
}
// JSON ë¬¸ìì—´ì„ rows/columns ë°°ì—´ë¡œ ë³€í™˜ (ë¡œë“œìš©)
function convertRowsForLoad(obj){
  if(!obj)return obj;
  if(Array.isArray(obj)){
    return obj.map(function(item){return convertRowsForLoad(item)});
  }
  if(typeof obj==='object'){
    var newObj={};
    for(var key in obj){
      if(key==='rowsJson'){
        try{newObj.rows=JSON.parse(obj[key])}catch(e){newObj.rows=[['','',''],['','','']]}
      }else if(key==='columnsJson'){
        try{newObj.columns=JSON.parse(obj[key])}catch(e){newObj.columns=['','']}
      }else{
        newObj[key]=convertRowsForLoad(obj[key]);
      }
    }
    return newObj;
  }
  return obj;
}
function saveDB(){
  var dataToSave=convertRowsForSave(db);
  return firestore.collection('app').doc('data').set(dataToSave).catch(function(e){console.error('ì €ì¥ ì‹¤íŒ¨:',e);toast('ì €ì¥ ì˜¤ë¥˜','err')});
}function toast(m,t){t=t||'ok';var w=$('toastWrap'),e=document.createElement('div');e.className='toast '+t;var ic={ok:'âœ…',err:'âŒ',warn:'âš ï¸'};e.innerHTML='<span style="font-size:18px">'+(ic[t]||'ğŸ’¬')+'</span><span style="font-size:14px">'+esc(m)+'</span>';w.appendChild(e);setTimeout(function(){e.style.opacity='0';setTimeout(function(){e.remove()},200)},3000)}
function setTheme(t){document.documentElement.setAttribute('data-theme',t);db.settings.theme=t;saveDB()}
function toggleTheme(){setTheme(db.settings.theme==='dark'?'light':'dark')}

// ë¡œê·¸ì¸
function handleLogin(e){
  e.preventDefault();
  var st=getLoginState();
  if(st.blocked){$('loginBlocked').style.display='block';$('loginForm').style.display='none';return}
  if(st.lockUntil>Date.now()){showLockTimer(st.lockUntil);return}
  var id=$('loginId').value.trim(),pw=$('loginPw').value,u=null;
  for(var i=0;i<db.users.length;i++){if(db.users[i].id===id&&db.users[i].pw===pw&&db.users[i].active){u=db.users[i];break}}
  if(!u){
    st.attempts++;
    var idExists=false;
    for(var j=0;j<db.users.length;j++){if(db.users[j].id===id){idExists=true;break}}
    var errMsg=idExists?'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.':'âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.';
    if(st.attempts>=15){st.blocked=true;saveLoginState(st);$('loginBlocked').style.display='block';$('loginForm').style.display='none';$('loginError').style.display='none';return}
    if(st.attempts>=5){st.lockUntil=Date.now()+5*60*1000;saveLoginState(st);showLockTimer(st.lockUntil);return}
    errMsg+=' ('+st.attempts+'/5)';
    $('loginError').textContent=errMsg;$('loginError').style.display='block';$('loginPw').value='';saveLoginState(st);return
  }
  st.attempts=0;st.lockUntil=0;saveLoginState(st);
  localStorage.setItem('ad_session',u.id);user=u;$('loginError').style.display='none';
  if(u.needPw){$('loginScreen').classList.add('hidden');openModal('pwChangeModal')}else initApp()
}
function showLockTimer(until){
  $('loginLocked').style.display='block';$('loginForm').style.display='none';$('loginError').style.display='none';
  var interval=setInterval(function(){
    var remaining=until-Date.now();
    if(remaining<=0){clearInterval(interval);$('loginLocked').style.display='none';$('loginForm').style.display='block';return}
    var min=Math.floor(remaining/60000),sec=Math.floor((remaining%60000)/1000);
    $('lockTimer').textContent=min+':'+(sec<10?'0':'')+sec
  },1000)
}
function skipPwChange(){closeModal('pwChangeModal');initApp()}
function submitPwChange(){
  var nick=$('pwNickname').value.trim(),c=$('pwCur').value,n=$('pwNew').value,cf=$('pwConfirm').value;
  if(!c||!n||!cf){toast('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','err');return}
  if(n!==cf){toast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','err');return}
  if(user.pw!==c){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤','err');return}
  for(var i=0;i<db.users.length;i++){
    if(db.users[i].id===user.id){db.users[i].pw=n;db.users[i].needPw=false;if(nick)db.users[i].nickname=nick;break}
  }
  saveDB();closeModal('pwChangeModal');toast('ì„¤ì • ì™„ë£Œ');initApp()
}
function logout(){localStorage.removeItem('ad_session');user=null;page=null;$('appWrap').style.display='none';$('loginScreen').classList.remove('hidden');$('loginId').value='';$('loginPw').value='';$('loginForm').style.display='block';$('loginLocked').style.display='none';closeAllModals();closeAllPanels();location.hash=''}
function isSuper(){return user&&user.id===SUPER}
function toggleMobile(){$('sidebar').classList.toggle('open');$('mobOverlay').classList.toggle('open')}
function closeMobile(){$('sidebar').classList.remove('open');$('mobOverlay').classList.remove('open')}
// í˜ì´ì§€ ê´€ë¦¬
function getPages(pid){var r=[];for(var i=0;i<db.pages.length;i++){if(db.pages[i].parentId===pid&&!db.pages[i].deleted)r.push(db.pages[i])}return r}
function getPage(id){for(var i=0;i<db.pages.length;i++){if(db.pages[i].id===id)return db.pages[i]}return null}
function getPath(id){var path=[],p=getPage(id);while(p){path.unshift(p);p=p.parentId?getPage(p.parentId):null}return path}
function createPage(pid,tplId){
  var tpl=null;if(tplId){for(var i=0;i<db.templates.length;i++){if(db.templates[i].id===tplId){tpl=db.templates[i];break}}}
  var blks=tpl?JSON.parse(JSON.stringify(tpl.blocks)):[{id:genId(),type:'text',content:''}];
  for(var j=0;j<blks.length;j++)blks[j].id=genId();
  var np={id:genId(),title:tpl?tpl.name:'ìƒˆ í˜ì´ì§€',icon:tpl?tpl.icon:'ğŸ“„',parentId:pid||null,blocks:blks,tags:[],author:user.id,created:Date.now(),updated:Date.now(),versions:[],comments:[],favorite:false,deleted:false};
  db.pages.push(np);saveDB();renderTree();loadPage(np.id);closeModal('templatesModal');toast('í˜ì´ì§€ ìƒì„±ë¨');
  setTimeout(function(){toggleEdit();$('pageTitle').focus();$('pageTitle').select()},100)
}
function loadPage(id){
  var p=getPage(id);if(!p)return;
  // í¸ì§‘ ì¤‘ í˜ì´ì§€ ì´íƒˆ í™•ì¸
  if(editMode&&hasChanges()){
    if(confirm('ì‘ì„±í•œ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){saveDoc()}
  }
  editMode=false;editBackup=null;
  page=p;
  // URL í•´ì‹œ ì—…ë°ì´íŠ¸
  history.pushState(null,null,'#'+id);
  $('pageIcon').textContent=p.icon;$('pageTitle').value=p.title;$('pageTitle').setAttribute('readonly','readonly');
  $('editBtn').style.display='inline-flex';$('deletePageBtn').style.display='inline-flex';
  $('saveBtn').style.display='none';$('cancelBtn').style.display='none';
  renderMeta();renderTags();renderBlocks();renderBC();renderTree();renderVer();renderCmt();
  db.recent=db.recent.filter(function(x){return x!==id});db.recent.unshift(id);if(db.recent.length>30)db.recent.pop();
  saveDB();closeMobile();$('editorWrap').scrollTop=0
}
function saveCurrent(){if(!page)return;var p=getPage(page.id);if(!p)return;p.title=$('pageTitle').value||'ì œëª© ì—†ìŒ';p.icon=$('pageIcon').textContent;p.blocks=collectBlocks();p.updated=Date.now();saveDB()}
function saveDoc(){
  if(!page)return;var p=getPage(page.id);if(!p)return;
  p.title=$('pageTitle').value||'ì œëª© ì—†ìŒ';p.icon=$('pageIcon').textContent;p.blocks=collectBlocks();p.updated=Date.now();
  p.versions.push({id:p.versions.length+1,date:Date.now(),author:user.id,blocks:JSON.parse(JSON.stringify(p.blocks))});
  if(p.versions.length>MAX_VER)p.versions.shift();
  saveDB();page=p;renderMeta();renderTree();renderVer();toast('ì €ì¥ë¨')
}
function toggleEdit(){
  if(!editMode){
    editMode=true;
    editBackup={title:$('pageTitle').value,icon:$('pageIcon').textContent,blocks:JSON.parse(JSON.stringify(page.blocks))};
    $('editor').classList.remove('view-mode');$('editor').classList.add('edit-mode');
    $('pageTitle').removeAttribute('readonly');
    $('editBtn').style.display='none';$('deletePageBtn').style.display='none';
    $('saveBtn').style.display='inline-flex';$('cancelBtn').style.display='inline-flex';
    renderBlocks();toast('í¸ì§‘ ëª¨ë“œ')
  }
}
function saveAndExit(){
  saveDoc();exitEditMode();toast('ì €ì¥ ì™„ë£Œ (ë²„ì „ ê¸°ë¡ë¨)')
}
function cancelEdit(){
  if(!editBackup)return;
  if(hasChanges()){
    if(confirm('ì‘ì„±í•œ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){saveAndExit();return}
  }
  $('pageTitle').value=editBackup.title;$('pageIcon').textContent=editBackup.icon;
  page.blocks=editBackup.blocks;
  exitEditMode();renderBlocks();toast('ì·¨ì†Œë¨')
}
function hasChanges(){
  if(!editBackup||!editMode)return false;
  if($('pageTitle').value!==editBackup.title)return true;
  if($('pageIcon').textContent!==editBackup.icon)return true;
  var current=collectBlocks();
  if(current.length!==editBackup.blocks.length)return true;
  for(var i=0;i<current.length;i++){
    if(current[i].content!==editBackup.blocks[i].content)return true;
  }
  return false
}
function exitEditMode(){
  editMode=false;editBackup=null;
  $('editor').classList.remove('edit-mode');$('editor').classList.add('view-mode');
  $('pageTitle').setAttribute('readonly','readonly');
  $('editBtn').style.display='inline-flex';$('deletePageBtn').style.display='inline-flex';
  $('saveBtn').style.display='none';$('cancelBtn').style.display='none';
  renderBlocks()
}
function deleteCurrentPage(){if(page)deletePage(page.id)}
function triggerAS(){if(!editMode)return;clearTimeout(autoT);autoT=setTimeout(saveCurrent,1500)}
function onTitleChange(){triggerAS()}
function deletePage(id){deleteTargetId=id;var p=getPage(id);$('deleteConfirmText').textContent='"'+p.title+'" í˜ì´ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?';openModal('deleteConfirmModal')}
function confirmDelete(){
  var id=deleteTargetId;closeModal('deleteConfirmModal');
  var p=getPage(id);if(!p)return;p.deleted=true;p.deletedAt=Date.now();saveDB();
  if(page&&page.id===id){var pgs=getPages(null);pgs.length>0?loadPage(pgs[0].id):createPage()}
  renderTree();toast('íœ´ì§€í†µìœ¼ë¡œ ì´ë™')
}
function restorePage(id){var p=getPage(id);if(p){p.deleted=false;delete p.deletedAt;saveDB();showTrash();renderTree();toast('ë³µì›ë¨')}}
function permanentDelete(id){if(!confirm('ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;db.pages=db.pages.filter(function(p){return p.id!==id});saveDB();showTrash();toast('ì‚­ì œë¨')}
function emptyTrash(){if(!isSuper()){toast('ê¶Œí•œ ì—†ìŒ','err');return}if(!confirm('íœ´ì§€í†µì„ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  í•­ëª©ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.'))return;db.pages=db.pages.filter(function(p){return!p.deleted});saveDB();showTrash();toast('íœ´ì§€í†µ ë¹„ì›€')}
function duplicatePage(id){var o=getPage(id);if(!o)return;var c=JSON.parse(JSON.stringify(o));c.id=genId();c.title+=' (ë³µì‚¬)';c.created=c.updated=Date.now();c.author=user.id;c.versions=[];c.comments=[];for(var i=0;i<c.blocks.length;i++)c.blocks[i].id=genId();db.pages.push(c);saveDB();renderTree();loadPage(c.id);toast('ë³µì œë¨')}
function toggleFavorite(id){var p=getPage(id);if(p){p.favorite=!p.favorite;saveDB();renderTree();toast(p.favorite?'ì¦ê²¨ì°¾ê¸° ì¶”ê°€':'ì¦ê²¨ì°¾ê¸° í•´ì œ')}}
function movePage(id,newParentId){
  if(id===newParentId)return;
  var p=getPage(id);if(!p)return;
  // ìˆœí™˜ ì°¸ì¡° ë°©ì§€
  var check=newParentId?getPage(newParentId):null;
  while(check){if(check.id===id)return;check=check.parentId?getPage(check.parentId):null}
  p.parentId=newParentId;saveDB();renderTree();toast('ì´ë™ë¨')
}
function renderBC(){var path=getPath(page.id),html='<span>'+esc(db.settings.wsName)+'</span>';for(var i=0;i<path.length;i++)html+=' / <span>'+path[i].icon+' '+esc(path[i].title)+'</span>';$('breadcrumb').innerHTML=html}
function renderMeta(){var authorName=user.nickname||page.author;$('pageMeta').innerHTML='<span>âœï¸ '+esc(authorName)+'</span><span>ğŸ“… '+fmtD(page.updated)+'</span><span>v'+(page.versions.length+1)+'</span>'}
function renderTags(){var html='';for(var i=0;i<page.tags.length;i++)html+='<span class="tag" onclick="removeTag(\''+esc(page.tags[i])+'\')">'+esc(page.tags[i])+' Ã—</span>';html+='<span class="tag tag-add" onclick="openTagModal()">+ íƒœê·¸</span>';$('pageTags').innerHTML=html}
function openTagModal(){$('tagInput').value='';openModal('tagModal');setTimeout(function(){$('tagInput').focus()},100)}
function submitTag(){var t=$('tagInput').value.trim();if(!t){toast('íƒœê·¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','err');return}if(page.tags.indexOf(t)!==-1){toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸','err');return}page.tags.push(t);saveDB();renderTags();closeModal('tagModal');toast('íƒœê·¸ ì¶”ê°€')}
function quickTag(t){if(page.tags.indexOf(t)!==-1){toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íƒœê·¸','err');return}page.tags.push(t);saveDB();renderTags();closeModal('tagModal');toast('íƒœê·¸ ì¶”ê°€')}
function removeTag(t){page.tags=page.tags.filter(function(x){return x!==t});saveDB();renderTags()}

// íŠ¸ë¦¬ ë Œë”ë§ (ë“œë˜ê·¸ì•¤ë“œë¡­)
function renderTree(){$('pageTree').innerHTML='';renderTreeLv(null,$('pageTree'))}
function renderTreeLv(pid,con){
  var pgs=getPages(pid);
  for(var i=0;i<pgs.length;i++){
    (function(p){
      var hasCh=getPages(p.id).length>0,isAct=page&&page.id===p.id;
      var item=document.createElement('div');item.className='tree-item';
      item.innerHTML='<div class="tree-row'+(isAct?' active':'')+'" data-id="'+p.id+'" draggable="true"><span class="tree-toggle'+(hasCh?'':' hide')+'">â–¶</span><span>'+p.icon+'</span><span class="tree-name">'+esc(p.title)+'</span><span class="tree-fav'+(p.favorite?' on':'')+'">â˜…</span></div><div class="tree-children closed"></div>';
      con.appendChild(item);
      var row=item.querySelector('.tree-row'),tog=item.querySelector('.tree-toggle'),ch=item.querySelector('.tree-children');
      row.addEventListener('click',function(e){if(!e.target.classList.contains('tree-toggle'))loadPage(p.id)});
      row.addEventListener('contextmenu',function(e){e.preventDefault();showPageCtx(e,p.id)});
      // ë“œë˜ê·¸
      row.addEventListener('dragstart',function(e){dragPageId=p.id;row.classList.add('dragging');e.dataTransfer.effectAllowed='move'});
      row.addEventListener('dragend',function(){dragPageId=null;row.classList.remove('dragging')});
      row.addEventListener('dragover',function(e){e.preventDefault();if(dragPageId&&dragPageId!==p.id)row.classList.add('drag-over')});
      row.addEventListener('dragleave',function(){row.classList.remove('drag-over')});
      row.addEventListener('drop',function(e){e.preventDefault();row.classList.remove('drag-over');if(dragPageId&&dragPageId!==p.id)movePage(dragPageId,p.id)});
      if(hasCh)tog.addEventListener('click',function(e){e.stopPropagation();tog.classList.toggle('open');ch.classList.toggle('closed');if(!ch.classList.contains('closed')&&ch.children.length===0)renderTreeLv(p.id,ch)})
    })(pgs[i])
  }
}
// íœ´ì§€í†µ ë“œë¡­
function setupTrashDrop(){
  var trash=$('trashDrop');
  trash.addEventListener('dragover',function(e){e.preventDefault();if(dragPageId)trash.classList.add('drag-over')});
  trash.addEventListener('dragleave',function(){trash.classList.remove('drag-over')});
  trash.addEventListener('drop',function(e){e.preventDefault();trash.classList.remove('drag-over');if(dragPageId){deletePage(dragPageId);dragPageId=null}})
}

// ë¸”ë¡ ë Œë”ë§
function renderBlocks(){var ed=$('editor');ed.innerHTML='';ed.className='editor '+(editMode?'edit-mode':'view-mode');for(var i=0;i<page.blocks.length;i++)ed.appendChild(createBlockEl(page.blocks[i],i));updateNums()}
function createBlockEl(b,idx){
  var div=document.createElement('div');
  div.className='block block-'+b.type;
  div.setAttribute('data-id',b.id);
  div.setAttribute('data-idx',idx);
  var ce=editMode?' contenteditable="true"':'';
  var inner='';
  
  switch(b.type){
    case'divider':
      inner='<hr>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'todo':
      if(b.checked)div.classList.add('done');
      inner='<label class="todo-wrap"><input type="checkbox"'+(b.checked?' checked':'')+(editMode?'':' onclick="return false"')+'><div class="block-content"'+ce+'>'+(b.content||'')+'</div></label>';
      break;
    case'toggle':
      inner='<div class="block-toggle-wrap">';
      inner+='<div class="block-toggle-head'+(b.open?' open':'')+'">';
      inner+='<span class="block-toggle-arrow" data-id="'+b.id+'">â–¶</span>';
      inner+='<div class="block-content"'+ce+'>'+(b.content||'')+'</div>';
      inner+='</div>';
      inner+='<div class="block-toggle-body'+(b.open?' open':'')+'">';
      inner+='<div class="block-content"'+ce+' data-placeholder="í† ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">'+(b.innerContent||'')+'</div>';
      inner+='</div>';
      inner+='</div>';
      break;
    case'callout':
      var ct=b.calloutType||'info',cIcon=b.icon||{info:'ğŸ’¡',success:'âœ…',warning:'âš ï¸',danger:'âŒ'}[ct];
      inner='<div class="block-callout-wrap '+ct+'">';
      inner+='<div class="block-callout-icon"'+(editMode?' onclick="openCalloutIconPicker(\''+b.id+'\')" style="cursor:pointer"':'')+'>'+cIcon+'</div>';
      inner+='<div style="flex:1"><div class="block-content"'+ce+'>'+(b.content||'')+'</div></div></div>';
      break;
    case'code':
      inner='<div class="block-code-wrap"><div class="block-code-head">';
      inner+='<span class="block-code-lang"'+(editMode?' onclick="openCodeSetting(\''+b.id+'\')" style="cursor:pointer"':'')+'>'+esc(b.lang||'code')+'</span>';
      inner+='<button class="btn btn-sm btn-s" onclick="copyCode(this)">ë³µì‚¬</button></div>';
      inner+='<div class="block-content"'+ce+' style="font-family:monospace;white-space:pre-wrap">'+(b.content||'')+'</div></div>';
      break;
    case'image':
      inner='<img src="'+esc(b.src||'')+'" style="max-width:100%;border-radius:var(--rad)" onerror="this.style.display=\'none\'">';
      inner+='<div class="block-image-caption"'+ce+' style="text-align:center;color:var(--t4);font-size:13px;margin-top:8px">'+(b.caption||'')+'</div>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'video':
      if(b.isFile){inner='<video controls style="width:100%;max-height:500px;border-radius:var(--rad)"><source src="'+esc(b.url)+'"></video>';}
      else{var vid=getYTId(b.url);inner=vid?'<iframe src="https://www.youtube.com/embed/'+vid+'" style="width:100%;height:400px;border:none;border-radius:var(--rad)" allowfullscreen></iframe>':'<div style="color:var(--err);padding:16px">ìœ íš¨í•˜ì§€ ì•Šì€ URL</div>';}
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'pdf':
      inner='<iframe src="'+esc(b.src||'')+'#toolbar=1" style="width:100%;height:500px;border:1px solid var(--bdr);border-radius:var(--rad)"></iframe>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'file':
      inner='<div class="block-file"><span>ğŸ“</span><a href="'+esc(b.url||'')+'" target="_blank">'+esc(b.name||'íŒŒì¼')+'</a></div>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'table':
      var rows=b.rows||[['','',''],['','','']],thc=b.headerColor||'',tdc=b.cellColor||'',tAlign=b.align||'left';
      inner='<div class="block-table-wrap"><table style="width:100%;border-collapse:collapse;text-align:'+tAlign+'">';
      for(var r=0;r<rows.length;r++){
        inner+='<tr>';
        for(var c=0;c<rows[r].length;c++){
          var cs=(r===0&&thc?'background:'+thc+';':'')+(r>0&&tdc?'background:'+tdc+';':'')+'padding:10px;border:1px solid var(--bdr);';
          inner+=(r===0?'<th':'<td')+ce+' style="'+cs+'">'+(rows[r][c]||'')+(r===0?'</th>':'</td>');
        }
        inner+='</tr>';
      }
      inner+='</table></div>';
      if(editMode){
        inner+='<div class="block-table-tools" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">';
        inner+='<button class="btn btn-sm btn-s" onclick="addTblRow(\''+b.id+'\')">+í–‰</button>';
        inner+='<button class="btn btn-sm btn-s" onclick="addTblCol(\''+b.id+'\')">+ì—´</button>';
        inner+='<button class="btn btn-sm btn-s" onclick="delTblRow(\''+b.id+'\')">-í–‰</button>';
        inner+='<button class="btn btn-sm btn-s" onclick="delTblCol(\''+b.id+'\')">-ì—´</button>';
        inner+='<select class="btn btn-sm btn-s" onchange="setTblAlign(\''+b.id+'\',this.value)"><option value="">ì •ë ¬</option><option value="left">ì™¼ìª½</option><option value="center">ê°€ìš´ë°</option><option value="right">ì˜¤ë¥¸ìª½</option></select>';
        inner+='<button class="btn btn-sm" style="color:var(--err)" onclick="deleteTable(\''+b.id+'\')">ì‚­ì œ</button>';
        inner+='</div>';
        inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      }
      break;
    case'toc':
      inner='<div class="block-toc-wrap">'+genTOC()+'</div>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'columns':
      var cols=b.columns||['',''];
      inner='<div class="block-columns-wrap" style="display:flex;gap:16px">';
      for(var ci=0;ci<cols.length;ci++){
        inner+='<div class="block-col" style="flex:1;min-width:0"><div class="block-col-content"'+ce+' style="min-height:60px;padding:12px;border:1px dashed var(--bdr);border-radius:var(--rad)">'+(cols[ci]||'')+'</div></div>';
      }
      inner+='</div>';
      if(editMode)inner+='<div class="block-add-below" onclick="addBlockBelow('+idx+')">+ ë¸”ë¡ ì¶”ê°€</div>';
      break;
    case'quote':
      inner='<div class="block-content"'+ce+'>'+(b.content||'')+'</div>';
      break;
    case'bullet':
      inner='<div class="block-content"'+ce+'>'+(b.content||'')+'</div>';
      break;
    case'number':
      div.setAttribute('data-num',b.num||1);
      inner='<div class="block-content"'+ce+'>'+(b.content||'')+'</div>';
      break;
    default:
      inner='<div class="block-content"'+ce+'>'+(b.content||'')+'</div>';
  }
  div.innerHTML='<div class="block-handle"><button class="btn btn-i" onclick="showBlockCtx(event,'+idx+')">â‹®</button></div>'+inner;
  setupBlockEv(div,b,idx);
  return div;
}
function setupBlockEv(div,b,idx){
  var cons=div.querySelectorAll('.block-content');
  for(var i=0;i<cons.length;i++){(function(el){
    // ë³´ê¸° ëª¨ë“œì—ì„œ ë”ë¸”í´ë¦­í•˜ë©´ í¸ì§‘ ëª¨ë“œë¡œ
    el.addEventListener('dblclick',function(){
      if(!editMode){toggleEdit();setTimeout(function(){focusBlock(idx)},50)}
    });
    el.addEventListener('input',triggerAS);
    el.addEventListener('keydown',function(e){handleKey(e,b,idx,el)});
    el.addEventListener('paste',handlePaste);
    el.addEventListener('compositionstart',function(){isComp=true});
    el.addEventListener('compositionend',function(){isComp=false});
    el.addEventListener('mouseup',showFmtBar);
    // í´ë¦­ ì‹œ í¬ì»¤ìŠ¤
    el.addEventListener('click',function(e){
      if(editMode&&el.getAttribute('contenteditable')==='true'){
        el.focus();
      }
    });
  })(cons[i])}
  
  // ë¸”ë¡ ì „ì²´ í´ë¦­ ì‹œ
  div.addEventListener('click',function(e){
    if(e.target.closest('.block-handle')||e.target.closest('.block-add-below')||e.target.closest('button')||e.target.closest('select')||e.target.closest('a'))return;
    var con=div.querySelector('.block-content')||div.querySelector('.block-col-content');
    if(con&&editMode){con.focus()}
  });
  
  // í…Œì´ë¸” ì…€
  var cells=div.querySelectorAll('th,td');
  for(var j=0;j<cells.length;j++){(function(cell){
    cell.addEventListener('input',triggerAS);
    cell.addEventListener('paste',handlePaste);
    cell.addEventListener('click',function(){if(editMode)cell.focus()});
    cell.addEventListener('dblclick',function(){if(!editMode){toggleEdit();setTimeout(function(){cell.focus()},50)}});
  })(cells[j])}
  
  // ì»¬ëŸ¼ ì½˜í…ì¸ 
  var colCons=div.querySelectorAll('.block-col-content');
  for(var k=0;k<colCons.length;k++){(function(el){
    el.addEventListener('dblclick',function(){if(!editMode){toggleEdit();setTimeout(function(){el.focus()},50)}});
    el.addEventListener('input',triggerAS);
    el.addEventListener('paste',handlePaste);
    el.addEventListener('mouseup',showFmtBar);
    el.addEventListener('keydown',function(e){
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();var wrap=el.closest('.block');if(wrap){var nidx=parseInt(wrap.getAttribute('data-idx'))+1;insertBlock(nidx,{id:genId(),type:'text',content:''})}}
    });
  })(colCons[k])}
  
  // ì´ë¯¸ì§€ ìº¡ì…˜
  var caption=div.querySelector('.block-image-caption');
  if(caption){
    caption.addEventListener('input',triggerAS);
    caption.addEventListener('paste',handlePaste);
    caption.addEventListener('dblclick',function(){if(!editMode){toggleEdit();setTimeout(function(){caption.focus()},50)}});
  }
  
  // í• ì¼ ì²´í¬ë°•ìŠ¤
  if(b.type==='todo'){
    var cb=div.querySelector('input[type="checkbox"]');
    if(cb){
      cb.addEventListener('change',function(){
        if(!editMode)return;
        b.checked=cb.checked;
        div.classList.toggle('done',b.checked);
        triggerAS();
      });
      cb.addEventListener('click',function(e){
        if(!editMode){e.preventDefault();toggleEdit()}
      });
    }
  }
  
  // í† ê¸€
  if(b.type==='toggle'){
    var arrow=div.querySelector('.block-toggle-arrow');
    var head=div.querySelector('.block-toggle-head');
    var body=div.querySelector('.block-toggle-body');
    if(arrow){
      arrow.addEventListener('click',function(e){
        e.preventDefault();
        e.stopPropagation();
        b.open=!b.open;
        head.classList.toggle('open',b.open);
        body.classList.toggle('open',b.open);
        // ìƒíƒœ ì €ì¥ (triggerAS ëŒ€ì‹  ì§ì ‘ ì €ì¥)
        for(var i=0;i<page.blocks.length;i++){
          if(page.blocks[i].id===b.id){page.blocks[i].open=b.open;break}
        }
      });
    }
    // í† ê¸€ ë°”ë””ì˜ block-contentì— ë³„ë„ ì´ë²¤íŠ¸
    var bodyContent=body.querySelector('.block-content');
    if(bodyContent){
      bodyContent.addEventListener('keydown',function(e){
        // Enter ì‹œ ê°™ì€ í† ê¸€ ë‚´ì—ì„œ ì²˜ë¦¬ (ìƒˆ ë¸”ë¡ ìƒì„± ì•ˆí•¨)
        if(e.key==='Enter'&&!e.shiftKey){
          e.stopPropagation();
          // ê¸°ë³¸ ì¤„ë°”ê¿ˆ í—ˆìš©
        }
      });
    }
  }
}
function handleKey(e,b,idx,el){
  if(isComp)return;
  var menu=$('slashMenu'),menuOpen=menu.classList.contains('open');
  if(menuOpen){
    if(e.key==='ArrowDown'){e.preventDefault();moveSlashSel(1);return}
    if(e.key==='ArrowUp'){e.preventDefault();moveSlashSel(-1);return}
    if(e.key==='Enter'){e.preventDefault();var sel=menu.querySelector('.slash-item.sel');if(sel)execSlash(sel.getAttribute('data-type'));return}
    if(e.key==='Escape'){e.preventDefault();hideSlash();return}
    if(e.key==='Backspace'){setTimeout(function(){var txt=el.innerText||el.textContent;if(!txt.startsWith('/'))hideSlash();else filterSlash(txt.slice(1))},0);return}
    if(e.key.length===1&&!e.ctrlKey&&!e.metaKey){setTimeout(function(){var txt=el.innerText||el.textContent;if(txt.startsWith('/'))filterSlash(txt.slice(1))},0);return}
  }
  
  /* ========== í…ìŠ¤íŠ¸ ì…ë ¥ ê·œì¹™ ==========
   * 1. Enter: ìƒˆ ë¸”ë¡ ìƒì„± (ê°™ì€ íƒ€ì… ìœ ì§€: bullet/number/todo)
   * 2. Shift+Enter: ê°™ì€ ë¸”ë¡ ë‚´ ì¤„ë°”ê¿ˆ
   * 3. Backspace (ë¹ˆ ë¸”ë¡): ë¦¬ìŠ¤íŠ¸â†’text ë³€í™˜, textâ†’ì´ì „ ë¸”ë¡ê³¼ ë³‘í•©
   * 4. Delete (ë¹ˆ ë¸”ë¡): ë‹¤ìŒ ë¸”ë¡ê³¼ ë³‘í•©
   * 5. Tab: ë“¤ì—¬ì“°ê¸° (ë¦¬ìŠ¤íŠ¸)
   * 6. Shift+Tab: ë‚´ì–´ì“°ê¸° (ë¦¬ìŠ¤íŠ¸)
   * 7. ë°©í–¥í‚¤ ìœ„ (ë§¨ ì•ì—ì„œ): ì´ì „ ë¸”ë¡ìœ¼ë¡œ ì´ë™
   * 8. ë°©í–¥í‚¤ ì•„ë˜ (ë§¨ ë’¤ì—ì„œ): ë‹¤ìŒ ë¸”ë¡ìœ¼ë¡œ ì´ë™
   * 9. Ctrl+B/I/U: ì„œì‹ ì ìš©
   * 10. /: ìŠ¬ë˜ì‹œ ë©”ë‰´ (ë¹ˆ ë¸”ë¡ì—ì„œë§Œ)
   */
  
  // ê·œì¹™ 1: Enter - ìƒˆ ë¸”ë¡ ìƒì„±
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    page.blocks[idx].content=el.innerHTML;
    var newType='text';
    // bullet/number/todoëŠ” ê°™ì€ íƒ€ì… ìœ ì§€, ë‹¨ ë¹ˆ ë‚´ìš©ì´ë©´ textë¡œ
    if((b.type==='bullet'||b.type==='number'||b.type==='todo')&&el.textContent.trim()!==''){
      newType=b.type;
    }
    var newB={id:genId(),type:newType,content:''};
    if(newType==='todo')newB.checked=false;
    insertBlock(idx+1,newB);
    updateNums();
    return;
  }
  
  // ê·œì¹™ 2: Shift+Enter - ì¤„ë°”ê¿ˆ (ê¸°ë³¸ ë™ì‘ í—ˆìš©)
  if(e.key==='Enter'&&e.shiftKey){
    return; // ê¸°ë³¸ ë™ì‘
  }
  
  // ê·œì¹™ 3: Backspace - ë¹ˆ ë¸”ë¡ ì²˜ë¦¬
  if(e.key==='Backspace'){
    var sel=window.getSelection();
    var atStart=sel.anchorOffset===0&&sel.isCollapsed;
    
    if(el.textContent===''||el.innerHTML==='<br>'){
      e.preventDefault();
      // ë¦¬ìŠ¤íŠ¸ íƒ€ì…ì´ë©´ textë¡œ ë³€í™˜
      if(b.type==='bullet'||b.type==='number'||b.type==='todo'){
        page.blocks[idx].type='text';
        renderBlocks();
        focusBlock(idx);
      }
      // textì´ê³  ì²« ë¸”ë¡ì´ ì•„ë‹ˆë©´ ì‚­ì œ
      else if(page.blocks.length>1){
        deleteBlock(idx);
      }
      return;
    }
    // ì»¤ì„œê°€ ë§¨ ì•ì´ê³  ì´ì „ ë¸”ë¡ì´ ìˆìœ¼ë©´ ë³‘í•©
    if(atStart&&idx>0){
      e.preventDefault();
      var prevB=page.blocks[idx-1];
      // ì´ì „ ë¸”ë¡ì´ text/h1/h2/h3/bullet/number/quoteë©´ ë³‘í•©
      if(['text','h1','h2','h3','bullet','number','quote'].includes(prevB.type)){
        var prevLen=(prevB.content||'').replace(/<[^>]*>/g,'').length;
        prevB.content=(prevB.content||'')+el.innerHTML;
        page.blocks.splice(idx,1);
        renderBlocks();
        focusBlock(idx-1,prevLen);
      }
      return;
    }
  }
  
  // ê·œì¹™ 4: Delete - ë‹¤ìŒ ë¸”ë¡ê³¼ ë³‘í•©
  if(e.key==='Delete'){
    var sel=window.getSelection();
    var atEnd=sel.anchorOffset===el.textContent.length&&sel.isCollapsed;
    if(atEnd&&idx<page.blocks.length-1){
      e.preventDefault();
      var nextB=page.blocks[idx+1];
      if(['text','h1','h2','h3','bullet','number','quote'].includes(nextB.type)){
        b.content=el.innerHTML+(nextB.content||'');
        page.blocks.splice(idx+1,1);
        renderBlocks();
        focusBlock(idx,el.textContent.length);
      }
      return;
    }
  }
  
  // ê·œì¹™ 7-8: ë°©í–¥í‚¤ë¡œ ë¸”ë¡ ì´ë™
  if(e.key==='ArrowUp'&&!e.shiftKey){
    var sel=window.getSelection();
    if(sel.anchorOffset===0&&idx>0){
      e.preventDefault();
      focusBlock(idx-1,-1); // -1ì€ ëìœ¼ë¡œ
      return;
    }
  }
  if(e.key==='ArrowDown'&&!e.shiftKey){
    var sel=window.getSelection();
    if(sel.anchorOffset===el.textContent.length&&idx<page.blocks.length-1){
      e.preventDefault();
      focusBlock(idx+1,0);
      return;
    }
  }
  
  // ê·œì¹™ 10: ìŠ¬ë˜ì‹œ ë©”ë‰´
  if(e.key==='/'&&el.textContent===''){
    slashSt={open:true,idx:idx};
    showSlash(el);
    return;
  }
  
  // ê·œì¹™ 9: ì„œì‹ ë‹¨ì¶•í‚¤
  if((e.metaKey||e.ctrlKey)&&!e.shiftKey){
    if(e.key==='b'){e.preventDefault();document.execCommand('bold');return}
    if(e.key==='i'){e.preventDefault();document.execCommand('italic');return}
    if(e.key==='u'){e.preventDefault();document.execCommand('underline');return}
  }
}
function handlePaste(e){e.preventDefault();var txt=e.clipboardData.getData('text/plain');document.execCommand('insertText',false,txt);triggerAS()}
function addTblRow(id){for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){var b=page.blocks[i];if(!b.rows)return;var cols=b.rows[0]?b.rows[0].length:3,nr=[];for(var j=0;j<cols;j++)nr.push('');b.rows.push(nr);renderBlocks();triggerAS();toast('í–‰ ì¶”ê°€');return}}}
function addTblCol(id){for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){var b=page.blocks[i];if(!b.rows)return;for(var j=0;j<b.rows.length;j++)b.rows[j].push('');renderBlocks();triggerAS();toast('ì—´ ì¶”ê°€');return}}}
function delTblRow(id){for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){var b=page.blocks[i];if(!b.rows||b.rows.length<=1)return;b.rows.pop();renderBlocks();triggerAS();toast('í–‰ ì‚­ì œ');return}}}
function delTblCol(id){for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){var b=page.blocks[i];if(!b.rows||b.rows[0].length<=1)return;for(var j=0;j<b.rows.length;j++)b.rows[j].pop();renderBlocks();triggerAS();toast('ì—´ ì‚­ì œ');return}}}
function setTblColor(id,type,color){if(!color)return;for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){var b=page.blocks[i];if(type==='header')b.headerColor=color;else b.cellColor=color;renderBlocks();triggerAS();return}}}
function setupTableResize(div,b){
  var resizers=div.querySelectorAll('.col-resizer');
  resizers.forEach(function(resizer){
    var colIdx=parseInt(resizer.getAttribute('data-col'));
    var startX,startW,th;
    resizer.addEventListener('mousedown',function(e){
      e.preventDefault();e.stopPropagation();
      th=div.querySelector('th[data-col="'+colIdx+'"]');
      if(!th)return;
      startX=e.pageX;startW=th.offsetWidth;
      resizer.classList.add('active');
      document.addEventListener('mousemove',onMouseMove);
      document.addEventListener('mouseup',onMouseUp);
    });
    function onMouseMove(e){
      if(!th)return;
      var w=Math.max(60,startW+(e.pageX-startX));
      th.style.width=w+'px';
      var tds=div.querySelectorAll('td[data-col="'+colIdx+'"]');
      tds.forEach(function(td){td.style.width=w+'px'});
    }
    function onMouseUp(){
      resizer.classList.remove('active');
      document.removeEventListener('mousemove',onMouseMove);
      document.removeEventListener('mouseup',onMouseUp);
      if(th){
        if(!b.colWidths)b.colWidths=[];
        b.colWidths[colIdx]=th.offsetWidth;
        triggerAS();
      }
    }
  });
}
function setupColResize(div,b){
  var dividers=div.querySelectorAll('.col-divider');
  dividers.forEach(function(divider){
    var colIdx=parseInt(divider.getAttribute('data-col'));
    var startX,col,startW,wrap;
    divider.addEventListener('mousedown',function(e){
      e.preventDefault();e.stopPropagation();
      wrap=div.querySelector('.block-columns-wrap');
      col=wrap.children[colIdx*2];
      if(!col)return;
      startX=e.pageX;startW=col.offsetWidth;
      divider.classList.add('active');
      document.addEventListener('mousemove',onMouseMove);
      document.addEventListener('mouseup',onMouseUp);
    });
    function onMouseMove(e){
      if(!col)return;
      var w=Math.max(80,startW+(e.pageX-startX));
      col.style.flex='0 0 '+w+'px';
    }
    function onMouseUp(){
      divider.classList.remove('active');
      document.removeEventListener('mousemove',onMouseMove);
      document.removeEventListener('mouseup',onMouseUp);
      if(col){
        if(!b.colWidths)b.colWidths=[];
        b.colWidths[colIdx]=col.offsetWidth;
        triggerAS();
      }
    }
  });
}
function scrollToBlk(id){var el=document.querySelector('[data-id="'+id+'"]');if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='var(--accM)';setTimeout(function(){el.style.background=''},2000)}}
function copyCode(btn){var wrap=btn.closest('.block-code-wrap'),code=wrap.querySelector('.block-content').textContent;navigator.clipboard.writeText(code).then(function(){toast('ë³µì‚¬ë¨')})}
function getYTId(url){if(!url)return null;var m=url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);return m?m[1]:null}
/* ========== ë¸”ë¡ ìƒì„±/ì‚­ì œ ê·œì¹™ ==========
 * 1. insertBlock: ì§€ì • ìœ„ì¹˜ì— ë¸”ë¡ ì‚½ì… í›„ í¬ì»¤ìŠ¤
 * 2. deleteBlock: ë¸”ë¡ ì‚­ì œ í›„ ì´ì „/ë‹¤ìŒ ë¸”ë¡ í¬ì»¤ìŠ¤
 * 3. addBlockBelow: íŠ¹ì • ë¸”ë¡ ì•„ë˜ì— ìƒˆ ë¸”ë¡ ì¶”ê°€
 * 4. dupBlock: ë¸”ë¡ ë³µì œ
 * 5. moveBlockUp/Down: ë¸”ë¡ ìœ„ì¹˜ ì´ë™
 * 6. ë¹ˆ ë¸”ë¡ ìë™ ì •ë¦¬ ì•ˆí•¨ (ì‚¬ìš©ì ì˜ë„ ì¡´ì¤‘)
 * 7. ë§ˆì§€ë§‰ ë¸”ë¡ ì‚­ì œ ì‹œ ë¹ˆ ë¸”ë¡ í•˜ë‚˜ ìœ ì§€
 * 8. í¸ì§‘ ë¶ˆê°€ ë¸”ë¡(toc,divider,image ë“±) ìƒì„± ì‹œ ì•„ë˜ ë¹ˆ ë¸”ë¡ ìë™ ì¶”ê°€
 * 9. í¬ì»¤ìŠ¤ ì´ë™ ì‹œ ì»¤ì„œ ìœ„ì¹˜ ì§€ì • ê°€ëŠ¥
 * 10. ë¸”ë¡ íƒ€ì… ë³€í™˜ ì‹œ ë‚´ìš© ìœ ì§€
 */
function focusBlock(idx,cursorPos){
  setTimeout(function(){
    var el=$('editor').children[idx];
    if(!el)return;
    var c=el.querySelector('.block-content');
    if(!c){
      // block-contentê°€ ì—†ìœ¼ë©´ block-col-contentë‚˜ th/td ì°¾ê¸°
      c=el.querySelector('.block-col-content')||el.querySelector('th')||el.querySelector('td');
    }
    if(!c)return;
    c.focus();
    // ì»¤ì„œ ìœ„ì¹˜ ì„¤ì •
    if(typeof cursorPos==='number'){
      try{
        var rng=document.createRange();
        var sel=window.getSelection();
        if(cursorPos===-1||cursorPos>=c.textContent.length){
          // ëìœ¼ë¡œ
          rng.selectNodeContents(c);
          rng.collapse(false);
        }else if(cursorPos===0){
          // ì²˜ìŒìœ¼ë¡œ
          rng.selectNodeContents(c);
          rng.collapse(true);
        }else{
          // íŠ¹ì • ìœ„ì¹˜
          var node=c.firstChild||c;
          if(node.nodeType===3){
            rng.setStart(node,Math.min(cursorPos,node.length));
            rng.collapse(true);
          }else{
            rng.selectNodeContents(c);
            rng.collapse(true);
          }
        }
        sel.removeAllRanges();
        sel.addRange(rng);
      }catch(ex){}
    }
  },30);
}
function insertBlock(idx,b){
  page.blocks.splice(idx,0,b);
  renderBlocks();
  focusBlock(idx,0);
}
function addBlockBelow(idx){
  insertBlock(idx+1,{id:genId(),type:'text',content:''});
}
function deleteBlock(idx){
  if(page.blocks.length<=1){
    // ë§ˆì§€ë§‰ ë¸”ë¡ì´ë©´ ë‚´ìš©ë§Œ ë¹„ìš°ê¸°
    page.blocks[0]={id:genId(),type:'text',content:''};
    renderBlocks();
    focusBlock(0,0);
    return;
  }
  page.blocks.splice(idx,1);
  renderBlocks();
  // ì‚­ì œëœ ìœ„ì¹˜ë‚˜ ì´ì „ ë¸”ë¡ìœ¼ë¡œ í¬ì»¤ìŠ¤
  var newIdx=Math.min(idx,page.blocks.length-1);
  focusBlock(newIdx,-1);
}
function dupBlock(idx){
  var orig=page.blocks[idx];
  var copy=JSON.parse(JSON.stringify(orig));
  copy.id=genId();
  page.blocks.splice(idx+1,0,copy);
  renderBlocks();
  focusBlock(idx+1,0);
  toast('ë¸”ë¡ ë³µì œë¨');
}
function moveBlockUp(idx){
  if(idx<=0)return;
  var temp=page.blocks[idx];
  page.blocks[idx]=page.blocks[idx-1];
  page.blocks[idx-1]=temp;
  renderBlocks();
  focusBlock(idx-1);
}
function moveBlockDown(idx){
  if(idx>=page.blocks.length-1)return;
  var temp=page.blocks[idx];
  page.blocks[idx]=page.blocks[idx+1];
  page.blocks[idx+1]=temp;
  renderBlocks();
  focusBlock(idx+1);
}
function collectBlocks(){var blks=[],chs=$('editor').children;for(var i=0;i<chs.length;i++){var el=chs[i],id=el.getAttribute('data-id'),orig=null;for(var j=0;j<page.blocks.length;j++){if(page.blocks[j].id===id){orig=page.blocks[j];break}}if(!orig)continue;var b=JSON.parse(JSON.stringify(orig)),con=el.querySelector('.block-content');if(con)b.content=con.innerHTML;if(b.type==='todo'){var cb=el.querySelector('input[type="checkbox"]');b.checked=cb?cb.checked:false}if(b.type==='toggle'){var inn=el.querySelector('.block-toggle-body .block-content');if(inn)b.innerContent=inn.innerHTML;var hd=el.querySelector('.block-toggle-head');b.open=hd?hd.classList.contains('open'):false}if(b.type==='image'){var cap=el.querySelector('.block-image-caption');if(cap)b.caption=cap.innerHTML}if(b.type==='table'){var rows=[],trs=el.querySelectorAll('tr'),cws=[];for(var ri=0;ri<trs.length;ri++){var cls=[],tds=trs[ri].querySelectorAll('th,td');for(var ci=0;ci<tds.length;ci++){cls.push(tds[ci].innerHTML.replace(/<div class="col-resizer"[^>]*><\/div>/g,''));if(ri===0&&tds[ci].offsetWidth)cws[ci]=tds[ci].offsetWidth}rows.push(cls)}b.rows=rows;if(cws.length)b.colWidths=cws}if(b.type==='columns'){var cols=[],ces=el.querySelectorAll('.block-col-content'),cwc=[];for(var coi=0;coi<ces.length;coi++){cols.push(ces[coi].innerHTML);var colEl=ces[coi].closest('.block-col');if(colEl&&colEl.offsetWidth)cwc[coi]=colEl.offsetWidth}b.columns=cols;if(cwc.length)b.colWidths=cwc}blks.push(b)}return blks}
function updateNums(){var n=0,chs=$('editor').children;for(var i=0;i<chs.length;i++){if(chs[i].classList.contains('block-number')){n++;chs[i].setAttribute('data-num',n)}else if(!chs[i].classList.contains('block-bullet'))n=0}}
function genTOC(){var hs=[];for(var i=0;i<page.blocks.length;i++){var b=page.blocks[i];if(b.type==='h1'||b.type==='h2'||b.type==='h3')hs.push(b)}if(hs.length===0)return'<div class="block-toc-title">ğŸ“‘ ëª©ì°¨</div><p style="color:var(--t4)">ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';var html='<div class="block-toc-title">ğŸ“‘ ëª©ì°¨</div><ul class="block-toc-list">';for(var j=0;j<hs.length;j++){var h=hs[j],txt=(h.content||'').replace(/<[^>]*>/g,''),lv=h.type==='h1'?1:h.type==='h2'?2:3;html+='<li class="block-toc-item l'+lv+'"><a href="#" onclick="scrollToBlk(\''+h.id+'\');return false">'+esc(txt)+'</a></li>'}html+='</ul>';return html}

// ì„œì‹ë°”/ìŠ¬ë˜ì‹œë©”ë‰´
function showFmtBar(){var sel=window.getSelection();if(!sel.rangeCount||sel.isCollapsed){hideFmtBar();return}var rng=sel.getRangeAt(0),rect=rng.getBoundingClientRect();if(rect.width<5){hideFmtBar();return}var bar=$('fmtBar');bar.style.left=Math.max(10,rect.left+rect.width/2-110)+'px';bar.style.top=Math.max(10,rect.top-50)+'px';bar.classList.add('open')}
function hideFmtBar(){$('fmtBar').classList.remove('open')}
function fmtCmd(cmd){document.execCommand(cmd,false,null);triggerAS()}
var savedSelection=null;
function saveSelection(){
  var sel=window.getSelection();
  if(sel.rangeCount>0)savedSelection=sel.getRangeAt(0).cloneRange();
}
function restoreSelection(){
  if(savedSelection){
    var sel=window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedSelection);
  }
}
function openColorPicker(){saveSelection();var html='';for(var i=0;i<COLORS.length;i++)html+='<div class="color-item" style="background:'+COLORS[i]+'" onclick="applyColor(\''+COLORS[i]+'\')"></div>';$('colorGrid').innerHTML=html;openModal('colorModal')}
function applyColor(c){closeModal('colorModal');restoreSelection();document.execCommand('foreColor',false,c);triggerAS()}
function showSlash(el){var rect=el.getBoundingClientRect(),menu=$('slashMenu');menu.style.left=Math.min(rect.left,window.innerWidth-320)+'px';menu.style.top=(rect.bottom+8)+'px';renderSlashMenu('');menu.classList.add('open')}
function hideSlash(){$('slashMenu').classList.remove('open');slashSt={open:false,idx:null}}
function renderSlashMenu(filter){
  var menu=$('slashMenu'),q=filter.toLowerCase().trim(),html='',hasItems=false,first=true;
  for(var s=0;s<SLASH.length;s++){
    var sec=SLASH[s],filtered=[];
    for(var i=0;i<sec.i.length;i++){var it=sec.i[i];if(!q||it.n.toLowerCase().indexOf(q)!==-1||it.t.toLowerCase().indexOf(q)!==-1)filtered.push(it)}
    if(filtered.length===0)continue;
    hasItems=true;html+='<div class="slash-section">'+sec.s+'</div>';
    for(var j=0;j<filtered.length;j++){var f=filtered[j];html+='<div class="slash-item'+(first?' sel':'')+'" data-type="'+f.t+'"><div class="slash-icon">'+f.c+'</div><div><div style="font-weight:500">'+f.n+'</div><div style="font-size:12px;color:var(--t4)">'+f.d+'</div></div></div>';first=false}
  }
  if(!hasItems)html='<div style="padding:20px;text-align:center;color:var(--t4)">ê²°ê³¼ ì—†ìŒ</div>';
  menu.innerHTML=html;
  var items=menu.querySelectorAll('.slash-item');
  for(var k=0;k<items.length;k++){(function(it){it.addEventListener('click',function(){execSlash(it.getAttribute('data-type'))});it.addEventListener('mouseenter',function(){var all=menu.querySelectorAll('.slash-item');for(var m=0;m<all.length;m++)all[m].classList.remove('sel');it.classList.add('sel')})})(items[k])}
}
function filterSlash(q){renderSlashMenu(q)}
function moveSlashSel(dir){var menu=$('slashMenu'),items=menu.querySelectorAll('.slash-item');if(!items.length)return;var cur=-1;for(var i=0;i<items.length;i++){if(items[i].classList.contains('sel')){cur=i;break}}var n=cur+dir;if(n<0)n=items.length-1;if(n>=items.length)n=0;for(var j=0;j<items.length;j++)items[j].classList.remove('sel');items[n].classList.add('sel');items[n].scrollIntoView({block:'nearest'})}
function execSlash(type){
  var idx=slashSt.idx;hideSlash();if(idx===null)return;
  if(type==='image'){slashSt.idx=idx;insertImage();return}
  if(type==='video'){slashSt.idx=idx;insertVideo();return}
  if(type==='pdf'){slashSt.idx=idx;insertPdf();return}
  if(type==='file'){slashSt.idx=idx;insertFile();return}
  var b=page.blocks[idx];b.type=type;b.content='';
  switch(type){
    case'table':b.rows=[['','',''],['','','']];break;
    case'callout':b.calloutType='info';break;
    case'number':b.num=1;break;
    case'toggle':b.open=false;b.innerContent='';break;
    case'todo':b.checked=false;break;
    case'col2':b.type='columns';b.colType='col2';b.columns=['',''];break;
    case'col3':b.type='columns';b.colType='col3';b.columns=['','',''];break;
  }
  // toc, divider ë“± í¸ì§‘ ë¶ˆê°€ ë¸”ë¡ì€ ì•„ë˜ì— ë¹ˆ ë¸”ë¡ ì¶”ê°€
  if(type==='toc'||type==='divider'){
    page.blocks.splice(idx+1,0,{id:genId(),type:'text',content:''});
  }
  renderBlocks();
  setTimeout(function(){
    var focusIdx=(type==='toc'||type==='divider')?idx+1:idx;
    var el=$('editor').children[focusIdx];
    if(el){var c=el.querySelector('.block-content')||el.querySelector('.block-col-content');if(c)c.focus()}
  },30)
}
var currentEditBlockId=null;
function insertImage(){openModal('imageUploadModal');$('imageUrlInput').value='';$('imageFileInput').value=''}
function submitImage(){
  var url=$('imageUrlInput').value.trim(),file=$('imageFileInput').files[0];
  if(file){
    var reader=new FileReader();
    reader.onload=function(e){addImageBlock(e.target.result)};
    reader.readAsDataURL(file)
  }else if(url){addImageBlock(url)}
  else{toast('URL ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”','err');return}
}
function addImageBlock(src){
  var b={id:genId(),type:'image',src:src,caption:''};
  if(slashSt.idx!==null){page.blocks[slashSt.idx]=b;slashSt.idx=null}else page.blocks.push(b);
  renderBlocks();triggerAS();closeModal('imageUploadModal');toast('ì´ë¯¸ì§€ ì‚½ì…')
}
function insertVideo(){openModal('videoUploadModal');$('videoUrlInput').value='';$('videoFileInput').value=''}
function submitVideo(){
  var url=$('videoUrlInput').value.trim(),file=$('videoFileInput').files[0];
  if(file){
    var reader=new FileReader();
    reader.onload=function(e){addVideoBlock(e.target.result,file.name)};
    reader.readAsDataURL(file)
  }else if(url){
    var vid=getYTId(url);
    if(!vid){toast('ìœ íš¨í•œ YouTube URLì„ ì…ë ¥í•˜ì„¸ìš”','err');return}
    addVideoBlock(url,null)
  }else{toast('URL ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”','err');return}
}
function addVideoBlock(src,fname){
  var b={id:genId(),type:'video',url:src,isFile:!!fname,fileName:fname||''};
  if(slashSt.idx!==null){page.blocks[slashSt.idx]=b;slashSt.idx=null}else page.blocks.push(b);
  renderBlocks();triggerAS();closeModal('videoUploadModal');toast('ë™ì˜ìƒ ì‚½ì…')
}
function insertPdf(){openModal('pdfUploadModal');$('pdfUrlInput').value='';$('pdfFileInput').value=''}
function submitPdf(){
  var url=$('pdfUrlInput').value.trim(),file=$('pdfFileInput').files[0];
  if(file){
    var reader=new FileReader();
    reader.onload=function(e){addPdfBlock(e.target.result)};
    reader.readAsDataURL(file)
  }else if(url){addPdfBlock(url)}
  else{toast('URL ë˜ëŠ” íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”','err');return}
}
function addPdfBlock(src){
  var b={id:genId(),type:'pdf',src:src};
  if(slashSt.idx!==null){page.blocks[slashSt.idx]=b;slashSt.idx=null}else page.blocks.push(b);
  renderBlocks();triggerAS();closeModal('pdfUploadModal');toast('PDF ì‚½ì…')
}
function insertFile(){openModal('fileUploadModal');$('fileFileInput').value=''}
function submitFile(){
  var file=$('fileFileInput').files[0];
  if(!file){toast('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”','err');return}
  var reader=new FileReader();
  reader.onload=function(e){
    var b={id:genId(),type:'file',url:e.target.result,name:file.name};
    if(slashSt.idx!==null){page.blocks[slashSt.idx]=b;slashSt.idx=null}else page.blocks.push(b);
    renderBlocks();triggerAS();closeModal('fileUploadModal');toast('íŒŒì¼ ì‚½ì…')
  };
  reader.readAsDataURL(file)
}
function openCalloutIconPicker(id){currentEditBlockId=id;var icons=['ğŸ’¡','âœ…','âš ï¸','âŒ','ğŸ“Œ','ğŸ””','ğŸ’¬','ğŸ“','ğŸ¯','â­','ğŸš€','ğŸ’ª','ğŸ”¥','â¤ï¸','ğŸ‘','ğŸ“¢'];var html='';for(var i=0;i<icons.length;i++)html+='<div class="icon-item" onclick="setCalloutIcon(\''+icons[i]+'\')">'+icons[i]+'</div>';$('calloutIconGrid').innerHTML=html;openModal('calloutIconModal')}
function setCalloutIcon(icon){if(!currentEditBlockId)return;for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===currentEditBlockId){page.blocks[i].icon=icon;break}}renderBlocks();triggerAS();closeModal('calloutIconModal');currentEditBlockId=null}
function openCodeSetting(id){currentEditBlockId=id;for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){$('codeLangInput').value=page.blocks[i].lang||'';break}}openModal('codeSettingModal')}
function submitCodeLang(){if(!currentEditBlockId)return;var lang=$('codeLangInput').value.trim();for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===currentEditBlockId){page.blocks[i].lang=lang;break}}renderBlocks();triggerAS();closeModal('codeSettingModal');currentEditBlockId=null;toast('ì €ì¥ë¨')}
function openTableSetting(id){currentEditBlockId=id;openModal('tableAlignModal')}
function setTblAlign(id,align){if(!align)return;for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){page.blocks[i].align=align;break}}renderBlocks();triggerAS()}
function deleteTable(id){if(!confirm('í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;for(var i=0;i<page.blocks.length;i++){if(page.blocks[i].id===id){page.blocks.splice(i,1);break}}renderBlocks();triggerAS();toast('í‘œ ì‚­ì œë¨')}
// ì»¨í…ìŠ¤íŠ¸/ë²„ì „/ëŒ“ê¸€
function showPageCtx(e,id){var m=$('ctxMenu');m.innerHTML='<div class="ctx-item" onclick="loadPage(\''+id+'\');hideCtx()"><span class="ctx-icon">ğŸ“„</span>ì—´ê¸°</div><div class="ctx-item" onclick="createPage(\''+id+'\');hideCtx()"><span class="ctx-icon">â•</span>í•˜ìœ„ í˜ì´ì§€</div><div class="ctx-divider"></div><div class="ctx-item" onclick="toggleFavorite(\''+id+'\');hideCtx()"><span class="ctx-icon">â­</span>ì¦ê²¨ì°¾ê¸°</div><div class="ctx-item" onclick="duplicatePage(\''+id+'\');hideCtx()"><span class="ctx-icon">ğŸ“‹</span>ë³µì œ</div><div class="ctx-divider"></div><div class="ctx-item danger" onclick="deletePage(\''+id+'\');hideCtx()"><span class="ctx-icon">ğŸ—‘ï¸</span>ì‚­ì œ</div>';showCtxAt(e.pageX,e.pageY)}
/* ========== í˜¸ë²„/UI ê·œì¹™ ==========
 * 1. í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ë¸”ë¡ í•¸ë“¤(â‹®) í‘œì‹œ
 * 2. ë¸”ë¡ í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ ë³€ê²½
 * 3. ë¸”ë¡ í´ë¦­ ì‹œ í•´ë‹¹ block-contentì— í¬ì»¤ìŠ¤
 * 4. ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´: ë³µì œ, ì‚­ì œ, ìœ„ë¡œ/ì•„ë˜ë¡œ ì´ë™, ë¸”ë¡ íƒ€ì… ë³€ê²½
 * 5. ë“œë˜ê·¸ ì‹œ ì‹œê°ì  í”¼ë“œë°±
 * 6. í¬ì»¤ìŠ¤ëœ ë¸”ë¡ í•˜ì´ë¼ì´íŠ¸
 * 7. ì—ë””í„° ì˜ì—­ í´ë¦­ ì‹œ ë§ˆì§€ë§‰ ë¸”ë¡ í¬ì»¤ìŠ¤
 * 8. ë¹ˆ ì—ë””í„° í´ë¦­ ì‹œ ìƒˆ ë¸”ë¡ ìƒì„±
 * 9. ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
 * 10. ESC í‚¤ë¡œ ë©”ë‰´/ëª¨ë‹¬ ë‹«ê¸°
 */
function showBlockCtx(e,idx){
  e.stopPropagation();
  var b=page.blocks[idx];
  var m=$('ctxMenu');
  var html='';
  // ë¸”ë¡ íƒ€ì… ë³€ê²½
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'text\');hideCtx()"><span class="ctx-icon">T</span>í…ìŠ¤íŠ¸</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'h1\');hideCtx()"><span class="ctx-icon">H1</span>ì œëª© 1</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'h2\');hideCtx()"><span class="ctx-icon">H2</span>ì œëª© 2</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'bullet\');hideCtx()"><span class="ctx-icon">â€¢</span>ê¸€ë¨¸ë¦¬</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'number\');hideCtx()"><span class="ctx-icon">1.</span>ë²ˆí˜¸</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'todo\');hideCtx()"><span class="ctx-icon">â˜‘</span>í• ì¼</div>';
  html+='<div class="ctx-item" onclick="changeBlockType('+idx+',\'quote\');hideCtx()"><span class="ctx-icon">"</span>ì¸ìš©</div>';
  html+='<div class="ctx-divider"></div>';
  // ìœ„ì¹˜ ì´ë™
  html+='<div class="ctx-item'+(idx===0?' disabled':'')+'" onclick="moveBlockUp('+idx+');hideCtx()"><span class="ctx-icon">â¬†ï¸</span>ìœ„ë¡œ ì´ë™</div>';
  html+='<div class="ctx-item'+(idx>=page.blocks.length-1?' disabled':'')+'" onclick="moveBlockDown('+idx+');hideCtx()"><span class="ctx-icon">â¬‡ï¸</span>ì•„ë˜ë¡œ ì´ë™</div>';
  html+='<div class="ctx-divider"></div>';
  // ë³µì œ/ì‚­ì œ
  html+='<div class="ctx-item" onclick="dupBlock('+idx+');hideCtx()"><span class="ctx-icon">ğŸ“‹</span>ë³µì œ</div>';
  html+='<div class="ctx-item" onclick="addBlockBelow('+idx+');hideCtx()"><span class="ctx-icon">â•</span>ì•„ë˜ì— ì¶”ê°€</div>';
  html+='<div class="ctx-divider"></div>';
  html+='<div class="ctx-item danger" onclick="deleteBlock('+idx+');hideCtx()"><span class="ctx-icon">ğŸ—‘ï¸</span>ì‚­ì œ</div>';
  m.innerHTML=html;
  showCtxAt(e.pageX,e.pageY);
}
function changeBlockType(idx,newType){
  var b=page.blocks[idx];
  var oldContent=b.content||'';
  b.type=newType;
  b.content=oldContent;
  if(newType==='todo')b.checked=false;
  if(newType==='toggle'){b.open=false;b.innerContent='';}
  renderBlocks();
  updateNums();
  focusBlock(idx,-1);
}
function showCtxAt(x,y){var m=$('ctxMenu');m.style.left=Math.min(x,window.innerWidth-180)+'px';m.style.top=Math.min(y,window.innerHeight-200)+'px';m.classList.add('open')}
function hideCtx(){$('ctxMenu').classList.remove('open')}
function dupBlock(idx){var b=page.blocks[idx],c=JSON.parse(JSON.stringify(b));c.id=genId();page.blocks.splice(idx+1,0,c);renderBlocks();triggerAS()}
function renderVer(){var list=page.versions.slice().reverse(),html='';if(list.length===0){$('versionList').innerHTML='<div style="text-align:center;color:var(--t4);padding:30px">ë²„ì „ ê¸°ë¡ ì—†ìŒ</div>';return}for(var i=0;i<list.length;i++){var v=list[i],isCur=i===0;html+='<div class="ver-item'+(isCur?' current':'')+'" onclick="'+(isCur?'':'restoreVer('+v.id+')')+'"><div><div style="font-weight:500">'+fmtDT(v.date)+(isCur?' <span class="badge badge-p">í˜„ì¬</span>':'')+'</div><div style="font-size:13px;color:var(--t4)">'+esc(v.author)+'</div></div>'+(isCur?'':'<button class="btn btn-sm btn-s" onclick="event.stopPropagation();deleteVer('+v.id+')">ì‚­ì œ</button>')+'</div>'}$('versionList').innerHTML=html}
function restoreVer(vid){var v=null;for(var i=0;i<page.versions.length;i++){if(page.versions[i].id===vid){v=page.versions[i];break}}if(!v||!v.blocks||!confirm('ì´ ë²„ì „ìœ¼ë¡œ ë³µì›?'))return;page.blocks=JSON.parse(JSON.stringify(v.blocks));renderBlocks();saveDoc();closePanel('versionPanel');toast('ë³µì›ë¨')}
function deleteVer(vid){if(!confirm('ë²„ì „ ì‚­ì œ?'))return;page.versions=page.versions.filter(function(v){return v.id!==vid});saveDB();renderVer();toast('ì‚­ì œë¨')}
function renderCmt(){var list=page.comments,html='';if(list.length===0){$('commentList').innerHTML='<div style="text-align:center;color:var(--t4);padding:30px">ëŒ“ê¸€ ì—†ìŒ</div>';return}for(var i=0;i<list.length;i++){var c=list[i],isOwner=(c.author===(user.nickname||user.id))||isSuper();html+='<div class="cmt-item"><div class="cmt-head"><div class="cmt-avatar">'+c.author.slice(-2).toUpperCase()+'</div><div style="flex:1"><div style="font-weight:500;font-size:14px">'+esc(c.author)+'</div><div style="font-size:12px;color:var(--t4)">'+fmtDT(c.date)+'</div></div>'+(isOwner?'<div style="display:flex;gap:4px"><button class="btn btn-sm btn-g" onclick="editComment(\''+c.id+'\')">âœï¸</button><button class="btn btn-sm btn-g" style="color:var(--err)" onclick="deleteComment(\''+c.id+'\')">ğŸ—‘ï¸</button></div>':'')+'</div><div style="font-size:14px;color:var(--t2);margin-top:8px">'+esc(c.text)+'</div></div>'}$('commentList').innerHTML=html}
function addComment(){var txt=$('commentInput').value.trim();if(!txt){toast('ëŒ“ê¸€ ì…ë ¥','err');return}page.comments.push({id:genId(),author:user.nickname||user.id,date:Date.now(),text:txt});saveDB();$('commentInput').value='';renderCmt();toast('ëŒ“ê¸€ ì‘ì„±')}
var editingCommentId=null;
function editComment(id){for(var i=0;i<page.comments.length;i++){if(page.comments[i].id===id){editingCommentId=id;$('editCommentInput').value=page.comments[i].text;openModal('editCommentModal');return}}}
function submitEditComment(){if(!editingCommentId)return;var txt=$('editCommentInput').value.trim();if(!txt){toast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”','err');return}for(var i=0;i<page.comments.length;i++){if(page.comments[i].id===editingCommentId){page.comments[i].text=txt;page.comments[i].date=Date.now();break}}saveDB();renderCmt();closeModal('editCommentModal');editingCommentId=null;toast('ëŒ“ê¸€ ìˆ˜ì •ë¨')}
function deleteComment(id){if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;page.comments=page.comments.filter(function(c){return c.id!==id});saveDB();renderCmt();toast('ëŒ“ê¸€ ì‚­ì œë¨')}
function openVersions(){closeAllPanels();$('versionPanel').classList.add('open')}
function openComments(){closeAllPanels();$('commentPanel').classList.add('open')}
function closePanel(id){$(id).classList.remove('open')}
function closeAllPanels(){$$('.panel').forEach(function(p){p.classList.remove('open')})}

// ëª¨ë‹¬/ì„¤ì •
function openModal(id){$(id).classList.add('open')}
function closeModal(id){$(id).classList.remove('open')}
function closeAllModals(){$$('.modal-bg').forEach(function(m){m.classList.remove('open')})}
function openSearch(){openModal('searchModal');$('searchInput').value='';$('searchInput').focus();doSearch('')}
function doSearch(q){q=q.toLowerCase().trim();var res=$('searchResults');if(!q){res.innerHTML='<div style="padding:40px;text-align:center;color:var(--t4)"><div style="font-size:40px;margin-bottom:12px">ğŸ”</div>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';return}var found=[];for(var i=0;i<db.pages.length;i++){var p=db.pages[i];if(p.deleted)continue;var m=p.title.toLowerCase().indexOf(q)!==-1;if(!m){for(var j=0;j<p.blocks.length;j++){if((p.blocks[j].content||'').toLowerCase().indexOf(q)!==-1){m=true;break}}}if(m)found.push(p)}if(found.length===0){res.innerHTML='<div style="padding:40px;text-align:center;color:var(--t4)"><div style="font-size:40px;margin-bottom:12px">ğŸ“­</div>ê²°ê³¼ ì—†ìŒ</div>';return}var html='';for(var k=0;k<found.length;k++){var f=found[k];html+='<div class="search-item" onclick="loadPage(\''+f.id+'\');closeModal(\'searchModal\')"><span style="font-size:22px">'+f.icon+'</span><div><div style="font-weight:500">'+esc(f.title)+'</div><div style="font-size:13px;color:var(--t4)">'+fmtD(f.updated)+'</div></div></div>'}res.innerHTML=html}
function openSettings(){
  openModal('settingsModal');
  $('setUserId').value=user.id;
  $('setNickname').value=user.nickname||'';
  $('setUserRole').value=isSuper()?'ìµœê³ ê´€ë¦¬ì':'ê´€ë¦¬ì';
  $('setWsName').value=db.settings.wsName;
  $('noticeContent').value=db.settings.notice||'';
  renderUsers();genNewUser();
  showSettingsTab('profile',document.querySelector('.tab-btn.on'))
}
function showSettingsTab(tab,btn){$$('.tab-btn').forEach(function(b){b.classList.remove('on')});$$('.tab-panel').forEach(function(p){p.classList.remove('on')});btn.classList.add('on');$('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('on')}
function saveNickname(){var nick=$('setNickname').value.trim();for(var i=0;i<db.users.length;i++){if(db.users[i].id===user.id){db.users[i].nickname=nick;break}}user.nickname=nick;saveDB();$('userName').textContent=nick||user.id;renderMeta();toast('ë‹‰ë„¤ì„ ì €ì¥')}
function renderUsers(){if(!isSuper()){$('usersTable').innerHTML='<tr><td style="text-align:center;padding:20px;color:var(--t4)">ê¶Œí•œ ì—†ìŒ</td></tr>';return}var html='<tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ìƒíƒœ</th><th></th></tr>';for(var i=0;i<db.users.length;i++){var u=db.users[i];html+='<tr><td>'+esc(u.id)+'</td><td>'+esc(u.nickname||'-')+'</td><td><span class="badge '+(u.active?'badge-p':'badge-w')+'">'+(u.active?'í™œì„±':'ë¹„í™œì„±')+'</span></td><td>'+(u.id!==SUPER?'<button class="btn btn-sm btn-s" onclick="resetPw(\''+u.id+'\')">ì´ˆê¸°í™”</button> <button class="btn btn-sm btn-s" onclick="toggleActive(\''+u.id+'\')">'+(u.active?'ë¹„í™œì„±':'í™œì„±')+'</button> <button class="btn btn-sm btn-d" onclick="delUser(\''+u.id+'\')">ì‚­ì œ</button>':'<span class="badge badge-w">ìµœê³ ê´€ë¦¬ì</span>')+'</td></tr>'}$('usersTable').innerHTML=html}
function genNewUser(){var id='admin'+Math.floor(1000+Math.random()*9000),chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789',pw='';for(var i=0;i<12;i++)pw+=chars[Math.floor(Math.random()*chars.length)];$('newUserId').value=id;$('newUserPw').value=pw}
function createUser(){if(!isSuper()){toast('ê¶Œí•œ ì—†ìŒ','err');return}var id=$('newUserId').value,pw=$('newUserPw').value;for(var i=0;i<db.users.length;i++){if(db.users[i].id===id){toast('ì¤‘ë³µ ì•„ì´ë””','err');return}}db.users.push({id:id,pw:pw,role:'admin',needPw:true,active:true,nickname:''});saveDB();renderUsers();genNewUser();toast('ì‚¬ìš©ì ìƒì„±')}
function resetPw(id){if(!isSuper())return;var chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789',pw='';for(var i=0;i<12;i++)pw+=chars[Math.floor(Math.random()*chars.length)];for(var j=0;j<db.users.length;j++){if(db.users[j].id===id){db.users[j].pw=pw;db.users[j].needPw=true;break}}saveDB();alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸: '+pw);renderUsers()}
function toggleActive(id){if(!isSuper())return;for(var i=0;i<db.users.length;i++){if(db.users[i].id===id){db.users[i].active=!db.users[i].active;break}}saveDB();renderUsers();toast('ìƒíƒœ ë³€ê²½')}
function delUser(id){if(!isSuper()||!confirm('ì‚­ì œ?'))return;db.users=db.users.filter(function(u){return u.id!==id});saveDB();renderUsers();toast('ì‚­ì œë¨')}
function changePassword(){var c=$('setPwCur').value,n=$('setPwNew').value;if(!c||!n){toast('ë¹„ë°€ë²ˆí˜¸ ì…ë ¥','err');return}if(user.pw!==c){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼','err');return}for(var i=0;i<db.users.length;i++){if(db.users[i].id===user.id){db.users[i].pw=n;break}}saveDB();user.pw=n;$('setPwCur').value=$('setPwNew').value='';toast('ë³€ê²½ë¨')}
function saveWorkspace(){db.settings.wsName=$('setWsName').value||'DocSpace';saveDB();$('wsName').textContent=db.settings.wsName;renderBC();toast('ì €ì¥ë¨')}
// ê³µì§€ì‚¬í•­
function saveNotice(){if(!isSuper()){toast('ê¶Œí•œ ì—†ìŒ','err');return}db.settings.notice=$('noticeContent').value;saveDB();updateNoticeBar();toast('ê³µì§€ ì €ì¥')}
function clearNotice(){if(!isSuper()){toast('ê¶Œí•œ ì—†ìŒ','err');return}db.settings.notice='';$('noticeContent').value='';saveDB();updateNoticeBar();toast('ê³µì§€ ì‚­ì œ')}
function updateNoticeBar(){if(db.settings.notice){$('noticeText').textContent=db.settings.notice;$('noticeBar').classList.add('show')}else{$('noticeBar').classList.remove('show')}}
function closeNoticeBar(){$('noticeBar').classList.remove('show')}
function showNotice(){if(db.settings.notice){$('noticeBody').textContent=db.settings.notice;openModal('noticeModal')}else{toast('ê³µì§€ì‚¬í•­ ì—†ìŒ','warn')}}
// ê¸°íƒ€ ëª¨ë‹¬
function showTrash(){
  var del=db.pages.filter(function(p){return p.deleted});
  var html='';
  if(del.length===0)html='<div style="text-align:center;color:var(--t4);padding:30px">íœ´ì§€í†µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
  else for(var i=0;i<del.length;i++){var p=del[i];html+='<div class="nav-item" style="justify-content:space-between"><div style="display:flex;align-items:center;gap:10px"><span>'+p.icon+'</span><span>'+esc(p.title)+'</span></div><div style="display:flex;gap:6px"><button class="btn btn-sm btn-s" onclick="restorePage(\''+p.id+'\')">ë³µì›</button>'+(isSuper()?'<button class="btn btn-sm btn-d" onclick="permanentDelete(\''+p.id+'\')">ì‚­ì œ</button>':'')+'</div></div>'}
  $('trashList').innerHTML=html;
  $('trashFoot').style.display=isSuper()&&del.length>0?'flex':'none';
  openModal('trashModal')
}
function showRecent(){var html='';if(db.recent.length===0)html='<div style="text-align:center;color:var(--t4);padding:30px">ìµœê·¼ ë¬¸ì„œ ì—†ìŒ</div>';else for(var i=0;i<Math.min(db.recent.length,15);i++){var p=getPage(db.recent[i]);if(p&&!p.deleted)html+='<div class="nav-item" onclick="loadPage(\''+p.id+'\');closeModal(\'recentModal\')"><span class="nav-icon">'+p.icon+'</span><span class="nav-text">'+esc(p.title)+'</span></div>'}$('recentList').innerHTML=html;openModal('recentModal')}
function showFavorites(){var favs=db.pages.filter(function(p){return p.favorite&&!p.deleted});var html='';if(favs.length===0)html='<div style="text-align:center;color:var(--t4);padding:30px">ì¦ê²¨ì°¾ê¸° ì—†ìŒ</div>';else for(var i=0;i<favs.length;i++){var p=favs[i];html+='<div class="nav-item" onclick="loadPage(\''+p.id+'\');closeModal(\'favoritesModal\')"><span class="nav-icon">'+p.icon+'</span><span class="nav-text">'+esc(p.title)+'</span></div>'}$('favoritesList').innerHTML=html;openModal('favoritesModal')}
function showTemplates(){var html='';for(var i=0;i<db.templates.length;i++){var t=db.templates[i];html+='<div class="nav-item" onclick="createPage(null,\''+t.id+'\')"><span class="nav-icon">'+t.icon+'</span><span class="nav-text">'+esc(t.name)+'</span></div>'}html+='<div class="nav-item" onclick="createPage()"><span class="nav-icon">ğŸ“„</span><span class="nav-text">ë¹ˆ í˜ì´ì§€</span></div>';$('templatesList').innerHTML=html;openModal('templatesModal')}
function openIconPicker(){var html='';for(var i=0;i<ICONS.length;i++)html+='<div class="icon-item" onclick="selectIcon(\''+ICONS[i]+'\')">'+ICONS[i]+'</div>';$('iconGrid').innerHTML=html;openModal('iconModal')}
function selectIcon(ic){page.icon=ic;$('pageIcon').textContent=ic;saveDB();renderTree();closeModal('iconModal')}
function openExport(){openModal('exportModal')}
function exportDoc(fmt){
  var title=page.title,content='';
  for(var i=0;i<page.blocks.length;i++){var b=page.blocks[i],txt=(b.content||'').replace(/<[^>]*>/g,'');if(txt)content+=txt+'\n\n'}
  var blob,fn;
  if(fmt==='md'){blob=new Blob(['# '+title+'\n\n'+content],{type:'text/markdown'});fn=title+'.md'}
  else if(fmt==='html'){var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+esc(title)+'</title><style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px;line-height:1.6}</style></head><body><h1>'+esc(title)+'</h1><div>'+$('editor').innerHTML+'</div></body></html>';blob=new Blob([html],{type:'text/html'});fn=title+'.html'}
  else if(fmt==='pdf'){exportPdf();return}
  else{blob=new Blob([title+'\n\n'+content],{type:'text/plain'});fn=title+'.txt'}
  var url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download=fn;a.click();URL.revokeObjectURL(url);closeModal('exportModal');toast('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ')
}
function exportPdf(){
  var title=page.title;
  var printWin=window.open('','_blank');
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'+esc(title)+'</title><style>@media print{@page{margin:20mm}body{font-family:-apple-system,BlinkMacSystemFont,"Pretendard",sans-serif;line-height:1.8;color:#333}h1{font-size:28px;margin-bottom:20px}h2{font-size:22px;margin:24px 0 12px}h3{font-size:18px;margin:20px 0 10px}p{margin:12px 0}ul,ol{margin:12px 0;padding-left:24px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background:#f5f5f5}blockquote{border-left:4px solid #ddd;padding-left:16px;margin:16px 0;color:#666}code{background:#f5f5f5;padding:2px 6px;border-radius:4px;font-family:monospace}.block-handle{display:none!important}}</style></head><body><h1>'+esc(title)+'</h1>'+$('editor').innerHTML+'<script>window.onload=function(){window.print();window.onafterprint=function(){window.close()}}<\/script></body></html>';
  printWin.document.write(html);
  printWin.document.close();
  closeModal('exportModal');toast('PDF ì¸ì‡„ ì°½ ì—´ë¦¼')
}

// ì´ˆê¸°í™”
function setupListeners(){
  document.addEventListener('click',function(e){
    if(!$('ctxMenu').contains(e.target))hideCtx();
    if(!$('slashMenu').contains(e.target)&&!e.target.classList.contains('block-content'))hideSlash();
    if(!$('fmtBar').contains(e.target)&&!e.target.closest('.block-content')&&!e.target.closest('.block-col-content'))hideFmtBar()
  });
  document.addEventListener('keydown',function(e){
    if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openSearch()}
    if((e.metaKey||e.ctrlKey)&&e.key==='s'){e.preventDefault();if(editMode)saveAndExit()}
    if(e.key==='Escape'){closeAllModals();closeAllPanels();hideCtx();hideSlash();hideFmtBar()}
  });
  window.addEventListener('resize',function(){if(window.innerWidth>768)closeMobile()});
  window.addEventListener('beforeunload',function(e){
    if(editMode&&hasChanges()){e.preventDefault();e.returnValue='ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';return e.returnValue}
  });
  
  // ì—ë””í„° ì˜ì—­ í´ë¦­ - ë¹ˆ ê³µê°„ í´ë¦­ ì‹œ ë§ˆì§€ë§‰ ë¸”ë¡ í¬ì»¤ìŠ¤ ë˜ëŠ” ìƒˆ ë¸”ë¡ ìƒì„±
  var editorWrap=$('editorWrap');
  editorWrap.addEventListener('click',function(e){
    if(!editMode)return;
    // í´ë¦­ì´ editor ë‚´ë¶€ ë¸”ë¡ì´ ì•„ë‹Œ ë¹ˆ ê³µê°„ì¼ ë•Œ
    var editor=$('editor');
    if(e.target===editor||e.target.classList.contains('editor-inner')){
      e.preventDefault();
      if(page.blocks.length===0){
        // ë¸”ë¡ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        page.blocks.push({id:genId(),type:'text',content:''});
        renderBlocks();
      }
      // ë§ˆì§€ë§‰ ë¸”ë¡ì˜ ë§ˆì§€ë§‰ì— í¬ì»¤ìŠ¤
      focusBlock(page.blocks.length-1,-1);
    }
  });
  
  // ì—ë””í„° ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  var editor=$('editor');
  editor.addEventListener('dragover',function(e){e.preventDefault();if(editMode)editor.classList.add('drag-over')});
  editor.addEventListener('dragleave',function(e){editor.classList.remove('drag-over')});
  editor.addEventListener('drop',function(e){
    e.preventDefault();editor.classList.remove('drag-over');
    if(!editMode)return;
    var files=e.dataTransfer.files;
    for(var i=0;i<files.length;i++){
      var file=files[i];
      if(file.type.startsWith('image/')){
        var reader=new FileReader();
        reader.onload=function(ev){addImageBlock(ev.target.result)};
        reader.readAsDataURL(file)
      }else if(file.type==='application/pdf'){
        var reader=new FileReader();
        reader.onload=function(ev){addPdfBlock(ev.target.result)};
        reader.readAsDataURL(file)
      }else{
        var reader=new FileReader();
        (function(f){
          reader.onload=function(ev){
            var b={id:genId(),type:'file',url:ev.target.result,name:f.name};
            page.blocks.push(b);renderBlocks();triggerAS()
          }
        })(file);
        reader.readAsDataURL(file)
      }
    }
  });
  $('loginForm').addEventListener('submit',handleLogin);
  setupTrashDrop();
}
function initApp(){
  $('loginScreen').classList.add('hidden');
  $('appWrap').style.display='flex';
  $('userName').textContent=user.nickname||user.id;
  $('userAvatar').textContent=(user.nickname||user.id).slice(-2).toUpperCase();
  $('userAvatar').className='user-avatar '+(isSuper()?'super':'admin');
  $('userRole').textContent=isSuper()?'ìµœê³ ê´€ë¦¬ì':'ê´€ë¦¬ì';
  $('wsName').textContent=db.settings.wsName;
  setTheme(db.settings.theme);
  updateNoticeBar();
  renderTree();
  // í•´ì‹œ ë¼ìš°íŒ…: URLì—ì„œ í˜ì´ì§€ ID ì½ê¸°
  var hashId=location.hash.slice(1);
  var targetPage=hashId?getPage(hashId):null;
  if(targetPage&&!targetPage.deleted){
    loadPage(targetPage.id);
  }else{
    var pgs=getPages(null);
    if(pgs.length>0)loadPage(pgs[0].id);else createPage()
  }
  // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì§€ì›
  window.addEventListener('popstate',function(){
    var hid=location.hash.slice(1);
    if(hid){var pg=getPage(hid);if(pg&&!pg.deleted)loadPageWithoutPush(hid)}
  });
}
// í•´ì‹œ ì—…ë°ì´íŠ¸ ì—†ì´ í˜ì´ì§€ ë¡œë“œ (popstateìš©)
function loadPageWithoutPush(id){
  var p=getPage(id);if(!p)return;
  if(editMode&&hasChanges()){if(confirm('ì‘ì„±í•œ ë‚´ìš©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){saveDoc()}}
  editMode=false;editBackup=null;page=p;
  $('pageIcon').textContent=p.icon;$('pageTitle').value=p.title;$('pageTitle').setAttribute('readonly','readonly');
  $('editBtn').style.display='inline-flex';$('deletePageBtn').style.display='inline-flex';
  $('saveBtn').style.display='none';$('cancelBtn').style.display='none';
  renderMeta();renderTags();renderBlocks();renderBC();renderTree();renderVer();renderCmt();
  db.recent=db.recent.filter(function(x){return x!==id});db.recent.unshift(id);if(db.recent.length>30)db.recent.pop();
  saveDB();closeMobile();$('editorWrap').scrollTop=0
}
function init(){
  initDB().then(function(){
    setupListeners();
    var st=getLoginState();
    if(st.blocked){$('loginBlocked').style.display='block';$('loginForm').style.display='none';return}
    if(st.lockUntil>Date.now()){showLockTimer(st.lockUntil);return}
    // ì„¸ì…˜ì€ localStorageì—ì„œ í™•ì¸ (ê¸°ê¸°ë³„ ë…ë¦½)
    var localSession=localStorage.getItem('ad_session');
    if(localSession){var u=null;for(var i=0;i<db.users.length;i++){if(db.users[i].id===localSession&&db.users[i].active){u=db.users[i];break}}if(u){user=u;initApp()}}
  });
}
// ì „ì—­
window.toggleTheme=toggleTheme;window.handleLogin=handleLogin;window.skipPwChange=skipPwChange;window.submitPwChange=submitPwChange;window.logout=logout;window.toggleMobile=toggleMobile;window.closeMobile=closeMobile;window.createPage=createPage;window.loadPage=loadPage;window.saveDoc=saveDoc;window.toggleEdit=toggleEdit;window.saveAndExit=saveAndExit;window.cancelEdit=cancelEdit;window.deleteCurrentPage=deleteCurrentPage;window.deletePage=deletePage;window.confirmDelete=confirmDelete;window.restorePage=restorePage;window.permanentDelete=permanentDelete;window.emptyTrash=emptyTrash;window.duplicatePage=duplicatePage;window.toggleFavorite=toggleFavorite;window.openTagModal=openTagModal;window.submitTag=submitTag;window.quickTag=quickTag;window.removeTag=removeTag;window.onTitleChange=onTitleChange;window.scrollToBlk=scrollToBlk;window.copyCode=copyCode;window.addTblRow=addTblRow;window.addTblCol=addTblCol;window.delTblRow=delTblRow;window.delTblCol=delTblCol;window.setTblColor=setTblColor;window.setTblAlign=setTblAlign;window.deleteTable=deleteTable;window.addBlockBelow=addBlockBelow;window.showBlockCtx=showBlockCtx;window.hideCtx=hideCtx;window.dupBlock=dupBlock;window.deleteBlock=deleteBlock;window.moveBlockUp=moveBlockUp;window.moveBlockDown=moveBlockDown;window.changeBlockType=changeBlockType;window.focusBlock=focusBlock;window.openVersions=openVersions;window.openComments=openComments;window.closePanel=closePanel;window.openModal=openModal;window.closeModal=closeModal;window.openSearch=openSearch;window.doSearch=doSearch;window.openSettings=openSettings;window.showSettingsTab=showSettingsTab;window.saveNickname=saveNickname;window.createUser=createUser;window.resetPw=resetPw;window.toggleActive=toggleActive;window.delUser=delUser;window.changePassword=changePassword;window.saveWorkspace=saveWorkspace;window.saveNotice=saveNotice;window.clearNotice=clearNotice;window.showNotice=showNotice;window.closeNoticeBar=closeNoticeBar;window.showTrash=showTrash;window.showRecent=showRecent;window.showFavorites=showFavorites;window.showTemplates=showTemplates;window.openIconPicker=openIconPicker;window.selectIcon=selectIcon;window.openExport=openExport;window.exportDoc=exportDoc;window.exportPdf=exportPdf;window.insertImage=insertImage;window.submitImage=submitImage;window.insertVideo=insertVideo;window.submitVideo=submitVideo;window.insertPdf=insertPdf;window.submitPdf=submitPdf;window.insertFile=insertFile;window.submitFile=submitFile;window.openCalloutIconPicker=openCalloutIconPicker;window.setCalloutIcon=setCalloutIcon;window.openCodeSetting=openCodeSetting;window.submitCodeLang=submitCodeLang;window.addComment=addComment;window.editComment=editComment;window.submitEditComment=submitEditComment;window.deleteComment=deleteComment;window.restoreVer=restoreVer;window.deleteVer=deleteVer;window.fmtCmd=fmtCmd;window.openColorPicker=openColorPicker;window.applyColor=applyColor;
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
} // startApp í•¨ìˆ˜ ë
</script>
</body>
</html>